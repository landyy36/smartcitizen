<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Citizen Portal</title>

  <!-- FAVICON -->
  <link rel="icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">

  <!-- LEAFLET (–∫–∞—Ä—Ç–∞) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#F2F4F7;
      --card:#ffffff;
      --text:#102A43;
      --muted:#52606D;
      --line:#E4E7EB;
      --nav:#102A43;
      --nav2:#243B53;
      --brand:#0B3C5D;
      --accent:#1E88E5;
      --shadow: 0 8px 24px rgba(16,42,67,0.08);
      --radius: 14px;

      /* –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -> —Ü–≤–µ—Ç–∞ */
      --c-roads:#ff3b30;
      --c-light:#ffcc00;
      --c-trash:#34c759;
      --c-water:#0a84ff;
      --c-other:#8e8e93;
    }
    [data-theme="dark"]{
      --bg:#0B1020;
      --card:#0F172A;
      --text:#E6EEF8;
      --muted:#A7B4C6;
      --line:#20304A;
      --nav:#0E1830;
      --nav2:#142240;
      --brand:#0A1F3A;
      --accent:#4DA3FF;
      --shadow: 0 10px 28px rgba(0,0,0,0.35);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: -apple-system, system-ui, Segoe UI, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    /* –ü–õ–ê–í–ù–û–°–¢–¨ / –ê–ù–ò–ú–ê–¶–ò–ò */
    .navitem, .btn, .btn2, .mini-btn, input, textarea, select, .card, .pill, .badge, .theme-toggle{
      transition: transform .18s ease, box-shadow .18s ease, background-color .18s ease, border-color .18s ease, color .18s ease, opacity .18s ease;
      will-change: transform;
    }
    .btn:hover, .btn2:hover, .mini-btn:hover{ transform: translateY(-1px); }
    .btn:active, .btn2:active, .mini-btn:active{ transform: translateY(0px) scale(.99); }

    .tab-anim{ animation: tabIn .22s ease both; }
    @keyframes tabIn{
      from{ opacity:0; transform: translateY(6px); }
      to{ opacity:1; transform: translateY(0); }
    }
    @media (prefers-reduced-motion: reduce){
      .tab-anim{ animation:none; }
      .navitem, .btn, .btn2, .mini-btn, input, textarea, select, .card, .pill, .badge, .theme-toggle{ transition:none; }
    }

    .topbar{
      height:64px;
      background: var(--brand);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 18px;
      position:sticky;
      top:0;
      z-index:50;
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
      font-weight:800;
      letter-spacing:.2px;
    }
    .logo{
      width:36px;height:36px;border-radius:10px;
      background: rgba(255,255,255,0.14);
      display:grid;place-items:center;
      font-weight:900;
    }
    .top-right{ display:flex; align-items:center; gap:10px; font-size:13px; opacity:.95; }
    .chip{
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.22);
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
    }

    .layout{ display:grid; grid-template-columns: 260px 1fr; min-height: calc(100vh - 64px); }

    .sidebar{
      background: var(--nav);
      color:#D9E2EC;
      padding:16px 12px;
      position:sticky;
      top:64px;
      height: calc(100vh - 64px);
      overflow:auto;
    }
    .navtitle{
      font-size:12px; opacity:.85; padding:8px 10px;
      text-transform: uppercase; letter-spacing:.08em;
    }
    .navitem{
      display:flex; gap:10px; align-items:center;
      padding:12px 12px; border-radius:12px;
      cursor:pointer; user-select:none;
      margin:4px 0;
    }
    .navitem:hover{ background: var(--nav2); }
    .navitem.active{ background: rgba(30,136,229,0.18); border: 1px solid rgba(30,136,229,0.35); }
    .navicon{ width:24px; text-align:center; }

    .sidebar-actions{ padding:12px; }
    .sidebar-bottom{ margin-top:8px; padding:12px; border-top: 1px solid rgba(217,226,236,0.12); }

    .theme-toggle{
      width:100%;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border-radius:14px;
      cursor:pointer; user-select:none;
      border:1px solid rgba(217,226,236,0.14);
      background: rgba(255,255,255,0.06);
      color:#D9E2EC;
    }
    .theme-icons{ display:flex; gap:8px; font-size:18px; align-items:center; }
    .theme-icons span{ opacity:.55; }
    .theme-icons .on{ opacity:1; transform: scale(1.05); }

    .main{ padding:18px; }
    .grid{ display:grid; grid-template-columns: 1.2fr 0.8fr; gap:16px; }
    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
      .sidebar{ position:relative; top:0; height:auto; }
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      margin-bottom:16px;
    }

    h2{ margin:0 0 10px; font-size:18px; }
    .muted{ color: var(--muted); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .spacer{ height:10px; }

    label{
      display:block; margin:10px 0 6px;
      font-size:13px; color: var(--muted); font-weight:600;
    }
    input, textarea, select{
      width:100%;
      padding:12px;
      border-radius:12px;
      border: 1px solid var(--line);
      background:#fff;
      color: var(--text);
      outline:none;
    }
    [data-theme="dark"] input,
    [data-theme="dark"] textarea,
    [data-theme="dark"] select{ background:#0B1224; }
    textarea{ min-height:110px; resize:vertical; }

    .btn{
      padding:12px 14px;
      border:0;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      background: var(--accent);
      color:#fff;
      box-shadow: 0 10px 20px rgba(30,136,229,.18);
    }
    .btn2{
      padding:12px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      background:transparent;
      color: var(--text);
      border: 1px solid var(--line);
    }
    .btn-danger{
      width:100%;
      background:transparent;
      border:1px solid #ffccd5;
      color:#a61b1b;
      font-weight:800;
      border-radius:12px;
      padding:12px 14px;
      cursor:pointer;
    }
    [data-theme="dark"] .btn-danger{ border-color:#5a1b1b; color:#ffb4b4; }

    .pill{
      display:inline-flex;
      padding:6px 10px;
      border-radius:999px;
      border: 1px solid var(--line);
      background:transparent;
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
    }

    .kpi{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .kpi .box{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:transparent;
    }
    .kpi .num{ font-size:20px; font-weight:900; }
    .kpi .lab{ font-size:12px; color: var(--muted); margin-top:4px; }

    .table-wrap{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:auto;
      background:transparent;
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width: 1100px;
    }
    th, td{
      padding:10px;
      border-bottom:1px solid var(--line);
      text-align:left;
      font-size:13px;
      vertical-align:top;
      white-space:nowrap;
    }
    td.wrap{ white-space:normal; }
    th{
      position:sticky;
      top:0;
      background:rgba(247,249,251,0.92);
      backdrop-filter: blur(6px);
      font-size:12px;
      color: var(--muted);
      text-transform:uppercase;
      letter-spacing:.06em;
      z-index:5;
    }
    [data-theme="dark"] th{ background: rgba(255,255,255,0.06); }

    .badge{
      display:inline-flex;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      border: 1px solid var(--line);
      background:transparent;
      color: var(--muted);
      white-space:nowrap;
    }
    .b-new{ border-color:#2b5fa2; background:rgba(30,136,229,0.16); color:#9fd0ff; }
    .b-proc{ border-color:#a86a1a; background:rgba(239,108,0,0.12); color:#ffd2a6; }
    .b-dept{ border-color:#334a6b; background:rgba(167,180,198,0.10); color:#cbd6e6; }
    .b-done{ border-color:#1c6b3a; background:rgba(46,125,50,0.12); color:#b7f0c0; }

    .hint{ font-size:12px; color: var(--muted); margin-top:8px; line-height:1.35; }
    .hide{ display:none !important; }

    .mini-btn{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background:transparent;
      cursor:pointer;
      font-weight:800;
      color: var(--text);
    }

    .status-select{
      border-radius:999px;
      padding:8px 10px;
      border:1px solid var(--line);
      font-weight:900;
      font-size:12px;
      background:transparent;
      width:auto;
    }

    .panel{
      margin-top:10px;
      border:1px dashed var(--line);
      border-radius:12px;
      padding:10px;
      background: rgba(255,255,255,0.04);
    }
    .panel textarea{ min-height:70px; }

    .footer{
      margin-top:16px;
      padding:14px 16px;
      border:1px solid var(--line);
      background:transparent;
      border-radius:14px;
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
    }
    .footer strong{ color: var(--text); }
    .footer .links{ display:flex; flex-wrap:wrap; gap:10px; margin-top:8px; }
    .footer a{ color: var(--accent); text-decoration:none; font-weight:700; }
    .footer a:hover{ text-decoration:underline; }

    /* ===== –ú–û–î–ê–õ–ö–ê –ö–ê–†–¢–´ ===== */
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
      padding:16px;
      animation: fadeIn .18s ease both;
    }
    .modal.on{ display:flex; }
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }

    .modal-card{
      width:min(980px, 100%);
      background: var(--card);
      border:1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      transform: translateY(6px);
      animation: popIn .2s ease both;
    }
    @keyframes popIn{ to{ transform: translateY(0); } }

    .modal-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
    }
    .modal-title{ font-weight:900; }
    .modal-body{ padding:12px; }
    .map{
      width:100%;
      height: 460px;
      border-radius:14px;
      overflow:hidden;
      border:1px solid var(--line);
    }
    .mapbar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-top:10px;
      justify-content:space-between;
    }
    .maphint{
      font-size:12px; color:var(--muted);
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .coord-pill{
      display:inline-flex;
      padding:6px 10px;
      border-radius:999px;
      border: 1px solid var(--line);
      font-size:12px;
      color: var(--muted);
      background: rgba(127,127,127,0.06);
    }

    /* ===== –ö–†–ê–°–ò–í–´–ï –ú–ê–†–ö–ï–†–´ ===== */
    .dot-marker{
      width:20px; height:20px;
      border-radius:999px;
      background:#fff;
      border:2px solid rgba(16,42,67,0.14);
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      display:grid;
      place-items:center;
    }
    .dot-marker .dot{
      width:10px; height:10px;
      border-radius:999px;
      background: var(--c-other);
    }
    .leaflet-tooltip.mytip{
      border:1px solid rgba(0,0,0,.08);
      border-radius:10px;
      box-shadow: 0 10px 22px rgba(0,0,0,.14);
      padding:8px 10px;
      font-weight:800;
    }
    [data-theme="dark"] .leaflet-tooltip.mytip{ border-color: rgba(255,255,255,.12); }

    /* ===== ADMIN: –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –¢–∞–±–ª–∏—Ü–∞/–ö–∞—Ä—Ç–∞ ===== */
    .seg{
      display:inline-flex;
      border:1px solid var(--line);
      border-radius:999px;
      overflow:hidden;
      background: rgba(127,127,127,0.06);
    }
    .seg button{
      border:0;
      padding:8px 12px;
      cursor:pointer;
      background:transparent;
      font-weight:900;
      color: var(--muted);
    }
    .seg button.on{
      background: rgba(30,136,229,0.14);
      color: var(--text);
    }

    /* ===== –§–û–¢–û: –º–∏–Ω–∏-–≥–∞–ª–µ—Ä–µ—è ===== */
    .thumbs{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }
    .thumb{
      width:84px;
      height:64px;
      border-radius:12px;
      border:1px solid var(--line);
      overflow:hidden;
      background: rgba(127,127,127,0.06);
      cursor:pointer;
      display:grid;
      place-items:center;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .photo-note{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:8px;
      color: var(--muted);
      font-size:12px;
      line-height:1.35;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo">SC</div>
      <div>
        Smart Citizen Portal<br>
        <span style="font-weight:600; font-size:12px; opacity:.9;">–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –æ–±—Ä–∞—â–µ–Ω–∏–π –≥—Ä–∞–∂–¥–∞–Ω</span>
      </div>
    </div>
    <div class="top-right">
      <span class="chip" id="today"></span>
      <span class="chip" id="sessionChip">–ì–æ—Å—Ç—å</span>
    </div>
  </div>

  <div class="layout">
    <aside class="sidebar">
      <div class="navtitle">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>

      <div class="navitem active" id="nav-auth" onclick="go('auth')"><div class="navicon">üîê</div><div>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div></div>
      <div class="navitem" id="nav-dashboard" onclick="go('dashboard')"><div class="navicon">üè†</div><div>–ì–ª–∞–≤–Ω–∞—è</div></div>
      <div class="navitem" id="nav-report" onclick="go('report')"><div class="navicon">‚ûï</div><div>–ü–æ–¥–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ</div></div>
      <div class="navitem" id="nav-my" onclick="go('my')"><div class="navicon">üìÇ</div><div>–ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</div></div>
      <div class="navitem" id="nav-track" onclick="go('track')"><div class="navicon">üîé</div><div>–¢—Ä–µ–∫–∏–Ω–≥ –ø–æ –Ω–æ–º–µ—Ä—É</div></div>

      <div class="navtitle" style="margin-top:8px;">–î–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>
      <div class="navitem" id="nav-admin" onclick="go('admin')"><div class="navicon">üèõÔ∏è</div><div>–†–µ–µ—Å—Ç—Ä –æ–±—Ä–∞—â–µ–Ω–∏–π</div></div>

      <div class="navitem" id="nav-help" onclick="go('help')"><div class="navicon">‚ùì</div><div>–ü–æ–º–æ—â—å</div></div>

      <div class="sidebar-actions">
        <button class="btn-danger" onclick="logout()">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
      </div>

      <div class="sidebar-bottom">
        <div class="theme-toggle" onclick="toggleTheme()" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
          <div style="font-weight:800;">–¢–µ–º–∞</div>
          <div class="theme-icons" aria-hidden="true">
            <span id="icoSun">‚òÄÔ∏è</span>
            <span id="icoMoon">üåô</span>
          </div>
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="grid">
        <div>
          <!-- AUTH -->
          <section class="card tab-anim" id="tab-auth">
            <h2>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <div class="muted">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å: <b>–ì—Ä–∞–∂–¥–∞–Ω–∏–Ω</b> –∏–ª–∏ <b>–ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ</b>.</div>

            <div class="spacer"></div>

            <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
            <input id="authName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: erasyl" />

            <label>–†–æ–ª—å</label>
            <select id="authRole">
              <option value="citizen">–ì—Ä–∞–∂–¥–∞–Ω–∏–Ω</option>
              <option value="gov">–ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ (–æ–ø–µ—Ä–∞—Ç–æ—Ä)</option>
            </select>

            <div id="govPassWrap" class="hide">
              <label>–ü–∞—Ä–æ–ª—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</label>
              <input id="govPass" type="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            </div>

            <div class="row" style="margin-top:10px;">
              <button class="btn" onclick="login()">–í–æ–π—Ç–∏</button>
              <span class="pill" id="authInfo">–°—Ç–∞—Ç—É—Å: –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span>
            </div>
          </section>

          <!-- DASH -->
          <section class="card hide" id="tab-dashboard">
            <h2>–ì–ª–∞–≤–Ω–∞—è</h2>
            <div class="muted">–°–≤–æ–¥–∫–∞ –∏ –±—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è.</div>

            <div class="spacer"></div>

            <div class="kpi">
              <div class="box"><div class="num" id="kpiTotal">0</div><div class="lab">–í—Å–µ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏–π</div></div>
              <div class="box"><div class="num" id="kpiActive">0</div><div class="lab">–í —Ä–∞–±–æ—Ç–µ</div></div>
              <div class="box"><div class="num" id="kpiDone">0</div><div class="lab">–†–µ—à–µ–Ω–æ</div></div>
            </div>

            <div class="spacer"></div>

            <div class="row">
              <button class="btn2" onclick="go('report')">–ü–æ–¥–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ</button>
              <button class="btn2" onclick="go('track')">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
            </div>
          </section>

          <!-- REPORT -->
          <section class="card hide" id="tab-report">
            <h2>–ü–æ–¥–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ</h2>
            <div class="muted">–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –∏ —É–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–æ. –ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Ç–æ—á–∫—É <b>–Ω–∞ –∫–∞—Ä—Ç–µ</b>.</div>

            <label>–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã</label>
            <textarea id="desc" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù–∞ —É–ª–∏—Ü–µ –ê–±–∞—è –±–æ–ª—å—à–∞—è —è–º–∞ –Ω–∞ –¥–æ—Ä–æ–≥–µ..."></textarea>

            <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <select id="type" onchange="refreshPickMarkerStyle()">
              <option value="auto">–ê–≤—Ç–æ (–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)</option>
              <option value="roads">–î–æ—Ä–æ–≥–∏</option>
              <option value="light">–û—Å–≤–µ—â–µ–Ω–∏–µ</option>
              <option value="trash">–ú—É—Å–æ—Ä</option>
              <option value="water">–í–æ–¥–∞ / –ø–æ–¥—Ç–æ–ø–ª–µ–Ω–∏—è</option>
              <option value="other">–î—Ä—É–≥–æ–µ</option>
            </select>

            <!-- NEW: —Ñ–æ—Ç–æ -->
            <label>–§–æ—Ç–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
            <input id="photos" type="file" accept="image/*" multiple />
            <div class="photo-note">
              <span class="pill" id="photoCountPill">–§–æ—Ç–æ: 0</span>
              <span>–§–∞–π–ª—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–º–µ–Ω—å—à–∞—é—Ç—Å—è (—á—Ç–æ–±—ã –Ω–µ –∑–∞–±–∏—Ç—å localStorage).</span>
            </div>

            <!-- –î–í–ï –ö–ù–û–ü–ö–ò -->
            <div class="row" style="margin-top:14px;">
              <button class="btn2" onclick="useMapPlace()">–í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</button>
              <button class="btn2" onclick="useManualPlace()">–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é</button>
            </div>

            <!-- –ë–õ–û–ö: –≤—Ä—É—á–Ω—É—é -->
            <div id="manualPlaceBlock" style="margin-top:6px;">
              <label>–†–µ–≥–∏–æ–Ω</label>
              <select id="region">
                <option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω ‚Äî</option>
                <option>–ê—Å—Ç–∞–Ω–∞</option>
                <option>–ê–ª–º–∞—Ç—ã</option>
                <option>–®—ã–º–∫–µ–Ω—Ç</option>
                <option>–ê–∫–º–æ–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                <option>–ê–∫—Ç—é–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                <option>–ê–ª–º–∞—Ç–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                <option>–ê—Ç—ã—Ä–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                <option>–í–æ—Å—Ç–æ—á–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                <option>–ñ–∞–º–±—ã–ª—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                <option>–ñ–µ—Ç—ã—Å—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                <option>–ó–∞–ø–∞–¥–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                <option>–ö–∞—Ä–∞–≥–∞–Ω–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                <option>–ö–æ—Å—Ç–∞–Ω–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                <option>–ö—ã–∑—ã–ª–æ—Ä–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                <option>–ú–∞–Ω–≥–∏—Å—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                <option>–ü–∞–≤–ª–æ–¥–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                <option>–°–µ–≤–µ—Ä–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                <option>–¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                <option>–£–ª—ã—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                <option>–ê–±–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
              </select>

              <label>–õ–æ–∫–∞—Ü–∏—è (—Ç–µ–∫—Å—Ç)</label>
              <input id="loc" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –æ—Ä–∏–µ–Ω—Ç–∏—Ä" />
            </div>

            <!-- –ë–õ–û–ö: –ø–æ –∫–∞—Ä—Ç–µ -->
            <div id="mapPlaceBlock" class="hide" style="margin-top:6px;">
              <label>–õ–æ–∫–∞—Ü–∏—è (–ø–æ –∫–∞—Ä—Ç–µ)</label>
              <div class="row">
                <span class="coord-pill" id="pickedCoordPill">–¢–æ—á–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞</span>
                <button class="btn2" onclick="openPickMap()">–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É</button>
              </div>
              <div class="hint">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ ‚Äî –ø–æ—è–≤–∏—Ç—Å—è –±–µ–ª—ã–π –∫—Ä—É–≥. –¶–≤–µ—Ç = –∫–∞—Ç–µ–≥–æ—Ä–∏—è.</div>
            </div>

            <div class="row" style="margin-top:12px;">
              <button class="btn" onclick="submitReport()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
              <span class="pill" id="aiTag">–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è: ‚Äî</span>
            </div>

            <div id="result" class="hint"></div>
          </section>

          <!-- MY -->
          <section class="card hide" id="tab-my">
            <h2>–ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</h2>
            <div class="muted">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <b id="myUser"></b>. –†–µ–≥–∏–æ–Ω –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å.</div>
            <div class="spacer"></div>
            <div id="myList" class="hint">‚Äî</div>
          </section>

          <!-- TRACK -->
          <section class="card hide" id="tab-track">
            <h2>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ –Ω–æ–º–µ—Ä—É</h2>

            <label>–ù–æ–º–µ—Ä –æ–±—Ä–∞—â–µ–Ω–∏—è</label>
            <input id="trackId" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1024" />

            <div class="row" style="margin-top:12px;">
              <button class="btn" onclick="track()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
              <button class="btn2" onclick="go('dashboard')">–ù–∞–∑–∞–¥</button>
            </div>

            <div id="trackOut" class="hint"></div>
          </section>

          <!-- ADMIN -->
          <section class="card hide" id="tab-admin">
            <div class="row" style="justify-content:space-between; gap:12px;">
              <div>
                <h2 style="margin-bottom:4px;">–†–µ–µ—Å—Ç—Ä –æ–±—Ä–∞—â–µ–Ω–∏–π</h2>
                <div class="muted">–¢–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ –ø–æ–¥—Å–≤–µ—á–µ–Ω—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏. –ù–∞–≤–µ–¥–∏ –∫—É—Ä—Å–æ—Ä ‚Äî —É–≤–∏–¥–∏—à—å –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ.</div>
              </div>

              <div class="seg" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∞">
                <button id="btnAdminTable" class="on" onclick="setAdminView('table')">–¢–∞–±–ª–∏—Ü–∞</button>
                <button id="btnAdminMap" onclick="setAdminView('map')">–ö–∞—Ä—Ç–∞</button>
              </div>
            </div>

            <div class="row" style="margin:12px 0;">
              <label style="margin:0;">–§–∏–ª—å—Ç—Ä:</label>
              <select id="filter" onchange="renderAll()" style="max-width:220px;">
                <option value="all">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                <option value="roads">–î–æ—Ä–æ–≥–∏</option>
                <option value="light">–û—Å–≤–µ—â–µ–Ω–∏–µ</option>
                <option value="trash">–ú—É—Å–æ—Ä</option>
                <option value="water">–í–æ–¥–∞/–ø–æ–¥—Ç–æ–ø–ª–µ–Ω–∏—è</option>
                <option value="other">–î—Ä—É–≥–æ–µ</option>
              </select>

              <select id="statusFilter" onchange="renderAll()" style="max-width:220px;">
                <option value="any">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                <option value="0">–ü—Ä–∏–Ω—è—Ç–æ</option>
                <option value="1">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
                <option value="2">–ü–µ—Ä–µ–¥–∞–Ω–æ –≤ –æ—Ç–¥–µ–ª</option>
                <option value="3">–†–µ—à–µ–Ω–æ</option>
              </select>

              <select id="regionFilter" onchange="renderAll()" style="max-width:260px;">
                <option value="any">–í—Å–µ —Ä–µ–≥–∏–æ–Ω—ã</option>
              </select>
            </div>

            <!-- ADMIN MAP -->
            <div id="adminMapWrap" class="hide">
              <div class="map" id="adminMap"></div>
              <div class="hint" style="margin-top:8px;">
                –õ–µ–≥–µ–Ω–¥–∞:
                <span class="pill" style="border-color:rgba(127,127,127,.25)"><span style="display:inline-block;width:10px;height:10px;border-radius:99px;background:var(--c-roads);margin-right:6px;"></span>–î–æ—Ä–æ–≥–∏</span>
                <span class="pill" style="border-color:rgba(127,127,127,.25)"><span style="display:inline-block;width:10px;height:10px;border-radius:99px;background:var(--c-light);margin-right:6px;"></span>–û—Å–≤–µ—â–µ–Ω–∏–µ</span>
                <span class="pill" style="border-color:rgba(127,127,127,.25)"><span style="display:inline-block;width:10px;height:10px;border-radius:99px;background:var(--c-trash);margin-right:6px;"></span>–ú—É—Å–æ—Ä</span>
                <span class="pill" style="border-color:rgba(127,127,127,.25)"><span style="display:inline-block;width:10px;height:10px;border-radius:99px;background:var(--c-water);margin-right:6px;"></span>–í–æ–¥–∞</span>
                <span class="pill" style="border-color:rgba(127,127,127,.25)"><span style="display:inline-block;width:10px;height:10px;border-radius:99px;background:var(--c-other);margin-right:6px;"></span>–î—Ä—É–≥–æ–µ</span>
              </div>
            </div>

            <!-- ADMIN TABLE -->
            <div id="adminTableWrap">
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th style="min-width:90px;">ID</th>
                      <th style="min-width:140px;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                      <th style="min-width:140px;">–ì—Ä–∞–∂–¥–∞–Ω–∏–Ω</th>
                      <th style="min-width:170px;">–†–µ–≥–∏–æ–Ω</th>
                      <th style="min-width:220px;">–õ–æ–∫–∞—Ü–∏—è</th>
                      <th style="min-width:190px;">–°—Ç–∞—Ç—É—Å</th>
                      <th style="min-width:200px;">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                  </thead>
                  <tbody id="tbody"></tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- HELP -->
          <section class="card hide" id="tab-help">
            <h2>–ü–æ–º–æ—â—å</h2>
            <div class="hint">
              ‚Ä¢ –í–æ–π–¥–∏—Ç–µ –∫–∞–∫ –≥—Ä–∞–∂–¥–∞–Ω–∏–Ω ‚Üí ‚Äú–ü–æ–¥–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ‚Äù.<br>
              ‚Ä¢ –ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ (—Ç–æ–≥–¥–∞ —Ä–µ–≥–∏–æ–Ω/—Ç–µ–∫—Å—Ç-–ª–æ–∫–∞—Ü–∏—è –Ω–µ –Ω—É–∂–Ω—ã).<br>
              ‚Ä¢ –ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ –º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ —Å–ø–∏—Å–æ–∫ –∏–ª–∏ —Å–º–æ—Ç—Ä–∏—Ç —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ.<br>
              ‚Ä¢ –§–æ—Ç–æ –º–æ–∂–Ω–æ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –ø—Ä–∏ –ø–æ–¥–∞—á–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∏ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –≤ —Ä–µ–µ—Å—Ç—Ä–µ.
            </div>
          </section>

          <div class="footer">
            <strong>–û —Å–µ—Ä–≤–∏—Å–µ Smart Citizen</strong><br>
            –ï–¥–∏–Ω—ã–π –ø–æ—Ä—Ç–∞–ª –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏–π –∂–∏—Ç–µ–ª–µ–π: —Ñ–∏–∫—Å–∏—Ä—É–π—Ç–µ –ø—Ä–æ–±–ª–µ–º—É, –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Å—Ç–∞—Ç—É—Å, –ø–æ–≤—ã—à–∞–π—Ç–µ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã —Å–ª—É–∂–±.
            <div class="links">
              <a href="javascript:void(0)" onclick="go('help')">–ü–æ–º–æ—â—å</a>
              <a href="javascript:void(0)" onclick="go('report')">–ü–æ–¥–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ</a>
              <a href="javascript:void(0)" onclick="go('track')">–¢—Ä–µ–∫–∏–Ω–≥</a>
            </div>
          </div>
        </div>

        <div></div>
      </div>
    </main>
  </div>

  <!-- –ú–û–î–ê–õ–ö–ê: –≤—ã–±–æ—Ä —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ -->
  <div class="modal" id="pickModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <div>
          <div class="modal-title">–í—ã–±–æ—Ä —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ</div>
          <div class="muted" style="font-size:12px;">–ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–µ, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏ ‚Äú–ì–æ—Ç–æ–≤–æ‚Äù.</div>
        </div>
        <button class="btn2" onclick="closePickMap()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="modal-body">
        <div class="map" id="pickMap"></div>

        <div class="mapbar">
          <div class="maphint">
            <span class="coord-pill" id="pickCoord">–¢–æ—á–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞</span>
            <span class="pill" id="pickCatPill">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ‚Äî</span>
          </div>
          <div class="row">
            <button class="btn2" onclick="centerKZ()">–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω</button>
            <button class="btn" onclick="confirmPick()">–ì–æ—Ç–æ–≤–æ</button>
          </div>
        </div>

        <div class="hint">–ú–∞—Ä–∫–µ—Ä —Ç–µ–ø–µ—Ä—å –Ω–µ ‚Äú–∫–∞–ø–ª—è‚Äù, –∞ –±–µ–ª—ã–π –∫—Ä—É–≥ —Å —Ü–≤–µ—Ç–æ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî –∫–∞–∫ —Ç—ã –ø—Ä–æ—Å–∏–ª.</div>
      </div>
    </div>
  </div>

  <!-- NEW: –ú–û–î–ê–õ–ö–ê –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ -->
  <div class="modal" id="photoModal" aria-hidden="true">
    <div class="modal-card" style="width:min(920px,100%);">
      <div class="modal-head">
        <div>
          <div class="modal-title" id="photoModalTitle">–§–æ—Ç–æ</div>
          <div class="muted" style="font-size:12px;" id="photoModalSub">‚Äî</div>
        </div>
        <button class="btn2" onclick="closePhotoModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="modal-body">
        <div style="border:1px solid var(--line); border-radius:14px; overflow:hidden; background:rgba(127,127,127,0.06);">
          <img id="photoModalImg" alt="–§–æ—Ç–æ –æ–±—Ä–∞—â–µ–Ω–∏—è" style="width:100%; height:auto; display:block;">
        </div>

        <div class="row" style="justify-content:space-between; margin-top:10px;">
          <button class="btn2" onclick="prevPhoto()">‚Üê</button>
          <span class="pill" id="photoModalCounter">1 / 1</span>
          <button class="btn2" onclick="nextPhoto()">‚Üí</button>
        </div>
      </div>
    </div>
  </div>

<script>
  const STORAGE_KEY = "smartCitizenPortal_v2";
  const USERS_KEY   = "smartCitizenUsers_v1";
  const THEME_KEY   = "smartCitizenTheme_v1";
  const SESSION_KEY = "smartCitizenSession_v1";

  const GOV_PASSWORD = "z123456!";

  const STATUS = ["–ü—Ä–∏–Ω—è—Ç–æ", "–í –æ–±—Ä–∞–±–æ—Ç–∫–µ", "–ü–µ—Ä–µ–¥–∞–Ω–æ –≤ –æ—Ç–¥–µ–ª", "–†–µ—à–µ–Ω–æ"];
  let reports = [];
  let users = [];
  let session = null;
  let openCommentId = null;

  /* ====== –ö–ê–†–¢–ê: –≤—ã–±–æ—Ä —Ç–æ—á–∫–∏ –≥—Ä–∞–∂–¥–∞–Ω–∏–Ω–æ–º ====== */
  let placeMode = "manual"; // "manual" | "map"
  let pickMap = null;
  let pickMarker = null;
  let pickedLatLng = null;

  /* ====== –ö–ê–†–¢–ê: view –¥–ª—è –ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–∞ ====== */
  let adminView = "table"; // "table" | "map"
  let adminMap = null;
  let adminLayer = null;

  /* ====== –§–û–¢–û: —Å–æ—Å—Ç–æ—è–Ω–∏–µ ====== */
  let pendingPhotos = []; // {name, type, dataUrl}
  const PHOTO_MAX_SIDE = 1280;   // –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ —Å—Ç–æ—Ä–æ–Ω–µ
  const PHOTO_QUALITY  = 0.78;   // jpg quality
  const PHOTO_MAX_COUNT = 6;     // –ª–∏–º–∏—Ç —Ñ–æ—Ç–æ –Ω–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ

  /* ====== –§–æ—Ç–æ-–º–æ–¥–∞–ª–∫–∞ ====== */
  let photoModalList = []; // {name,type,dataUrl}
  let photoModalIndex = 0;
  let photoModalContext = ""; // —Å—Ç—Ä–æ–∫–∞ —Ç–∏–ø–∞ "#1234"

  startClock();
  applySavedTheme();
  loadAll();
  restoreSession();
  hookAuthRoleUI();
  hookPhotoInput();
  buildRegionFilter();
  renderAll();
  go(session ? "dashboard" : "auth");

  window.addEventListener("storage", (e) => {
    if (e.key === STORAGE_KEY || e.key === USERS_KEY) {
      loadAll();
      buildRegionFilter();
      renderAll();
    }
    if (e.key === THEME_KEY) applySavedTheme();
  });

  function $(id){ return document.getElementById(id); }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function startClock(){
    const el = $("today");
    const tick = () => { if(el) el.textContent = new Date().toLocaleString("ru-RU"); };
    tick();
    setInterval(tick, 1000);
  }

  function applySavedTheme(){
    const t = localStorage.getItem(THEME_KEY) || "light";
    document.documentElement.setAttribute("data-theme", t);
    $("icoSun")?.classList.toggle("on", t === "light");
    $("icoMoon")?.classList.toggle("on", t === "dark");
  }
  function toggleTheme(){
    const cur = document.documentElement.getAttribute("data-theme") || "light";
    const next = (cur === "dark") ? "light" : "dark";
    localStorage.setItem(THEME_KEY, next);
    applySavedTheme();
    refreshPickMarkerStyle();
    renderAdminMapMarkers();
  }

  function loadAll(){
    try{ reports = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
    catch{ reports = []; }

    try{ users = JSON.parse(localStorage.getItem(USERS_KEY) || "[]"); }
    catch{ users = []; }

    reports.forEach(r => {
      if(!Array.isArray(r.comments)) r.comments = [];
      if(typeof r.statusIndex !== "number") r.statusIndex = 0;
      if(!r.region) r.region = "‚Äî";
      if(!r.loc) r.loc = "‚Äî";
      if(r.lat == null) r.lat = null;
      if(r.lng == null) r.lng = null;

      // NEW: —Ñ–æ—Ç–æ
      if(!Array.isArray(r.photos)) r.photos = [];
    });
  }

  function saveAll(){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(reports));
      localStorage.setItem(USERS_KEY, JSON.stringify(users));
    }catch(err){
      alert("–ü–∞–º—è—Ç—å localStorage –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞. –£–º–µ–Ω—å—à–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ/—Ä–∞–∑–º–µ—Ä —Ñ–æ—Ç–æ (–∏–ª–∏ —É–¥–∞–ª–∏ —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è).");
      console.error(err);
    }
  }

  function setSession(s){
    session = s;
    if(session) localStorage.setItem(SESSION_KEY, JSON.stringify(session));
    else localStorage.removeItem(SESSION_KEY);
    updateSessionUI();
  }

  function restoreSession(){
    try{
      const s = JSON.parse(localStorage.getItem(SESSION_KEY) || "null");
      session = (s && s.name && s.role) ? s : null;
    }catch{ session = null; }
    updateSessionUI();
  }

  function hookAuthRoleUI(){
    const roleSel = $("authRole");
    if(roleSel) roleSel.addEventListener("change", syncGovPasswordUI);
    syncGovPasswordUI();
  }

  function syncGovPasswordUI(){
    const role = $("authRole")?.value || "citizen";
    $("govPassWrap")?.classList.toggle("hide", role !== "gov");
  }

  function updateSessionUI(){
    const chip = $("sessionChip");
    const info = $("authInfo");
    if(session){
      const roleLabel = session.role === "gov" ? "–ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ" : "–ì—Ä–∞–∂–¥–∞–Ω–∏–Ω";
      chip && (chip.textContent = `${session.name} ¬∑ ${roleLabel}`);
      info && (info.textContent = `–°—Ç–∞—Ç—É—Å: –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫ ${roleLabel}`);
    }else{
      chip && (chip.textContent = "–ì–æ—Å—Ç—å");
      info && (info.textContent = "–°—Ç–∞—Ç—É—Å: –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω");
    }
  }

  function setActiveNav(key){
    ["auth","dashboard","report","my","track","admin","help"].forEach(k=>{
      $("nav-"+k)?.classList.toggle("active", k === key);
    });
  }

  function animateTab(el){
    if(!el) return;
    el.classList.remove("tab-anim");
    void el.offsetWidth;
    el.classList.add("tab-anim");
  }

  function go(name){
    if(name !== "auth" && !session){
      alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç.");
      name = "auth";
    }
    if(name === "admin" && session?.role !== "gov"){
      alert("–î–æ—Å—Ç—É–ø –≤ —Ä–µ–µ—Å—Ç—Ä —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–æ–ª–∏ ¬´–ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ¬ª.");
      name = "dashboard";
    }
    if(name === "report" && session?.role !== "citizen"){
      alert("–ü–æ–¥–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ ¬´–ì—Ä–∞–∂–¥–∞–Ω–∏–Ω¬ª.");
      name = "dashboard";
    }
    if(name === "my" && session?.role !== "citizen"){
      alert("–†–∞–∑–¥–µ–ª ¬´–ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è¬ª –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ ¬´–ì—Ä–∞–∂–¥–∞–Ω–∏–Ω—É¬ª.");
      name = "dashboard";
    }

    ["auth","dashboard","report","my","track","admin","help"].forEach(t=>{
      $("tab-"+t)?.classList.add("hide");
    });
    const tab = $("tab-"+name);
    tab?.classList.remove("hide");
    animateTab(tab);

    setActiveNav(name);

    const isCitizen = session?.role === "citizen";
    const isGov = session?.role === "gov";
    $("nav-report")?.classList.toggle("hide", !isCitizen);
    $("nav-my")?.classList.toggle("hide", !isCitizen);
    $("nav-admin")?.classList.toggle("hide", !isGov);

    if(name === "admin"){
      if(adminView === "map") initAdminMapOnce();
      setAdminView(adminView);
    }

    renderAll();
  }

  function login(){
    const name = ($("authName")?.value || "").trim();
    const role = $("authRole")?.value || "citizen";
    if(!name){ alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."); return; }

    if(role === "gov"){
      const pass = ($("govPass")?.value || "").trim();
      if(pass !== GOV_PASSWORD){
        alert("–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å");
        return;
      }
    }

    const existing = users.find(u => u.name.toLowerCase() === name.toLowerCase() && u.role === role);
    if(!existing){
      users.push({ name, role, createdAt: Date.now() });
      saveAll();
    }

    setSession({ name, role });

    if($("authName")) $("authName").value = "";
    if($("govPass")) $("govPass").value = "";

    go("dashboard");
  }

  function logout(){
    openCommentId = null;
    setSession(null);
    go("auth");
  }

  function aiClassify(text){
    const t = (text || "").toLowerCase();
    if (/(—è–º–∞|–¥–æ—Ä–æ–≥|–∞—Å—Ñ–∞–ª—å—Ç|—Ç—Ä–µ—â–∏–Ω|–ª—é–∫)/.test(t)) return "roads";
    if (/(—Ñ–æ–Ω–∞—Ä|—Å–≤–µ—Ç|–æ—Å–≤–µ—â)/.test(t)) return "light";
    if (/(–º—É—Å–æ—Ä|—Å–≤–∞–ª–∫|–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä|—É—Ä–Ω)/.test(t)) return "trash";
    if (/(–≤–æ–¥–∞|–∑–∞—Ç–æ–ø|–ø–∞–≤–æ–¥|–ª—É–∂|–∫–∞–Ω–∞–ª–∏–∑–∞—Ü)/.test(t)) return "water";
    return "other";
  }

  function catName(cat){
    return {roads:"–î–æ—Ä–æ–≥–∏", light:"–û—Å–≤–µ—â–µ–Ω–∏–µ", trash:"–ú—É—Å–æ—Ä", water:"–í–æ–¥–∞/–ø–æ–¥—Ç–æ–ø–ª–µ–Ω–∏—è", other:"–î—Ä—É–≥–æ–µ"}[cat] || "‚Äî";
  }

  function statusBadge(i){
    if(i===0) return `<span class="badge b-new">${STATUS[i]}</span>`;
    if(i===1) return `<span class="badge b-proc">${STATUS[i]}</span>`;
    if(i===2) return `<span class="badge b-dept">${STATUS[i]}</span>`;
    return `<span class="badge b-done">${STATUS[i]}</span>`;
  }

  function makeUniqueId(){
    let id, tries = 0;
    do{
      id = Math.floor(1000 + Math.random()*9000);
      tries++;
      if(tries > 60){
        id = Number(String(Date.now()).slice(-4));
        break;
      }
    }while(reports.some(r => r.id === id));
    return id;
  }

  /* ====== –§–û–¢–û: –æ–±—Ä–∞–±–æ—Ç–∫–∞ ====== */
  function hookPhotoInput(){
    const inp = $("photos");
    if(!inp) return;
    inp.addEventListener("change", async () => {
      const files = Array.from(inp.files || []);
      pendingPhotos = [];
      $("photoCountPill") && ($("photoCountPill").textContent = "–§–æ—Ç–æ: 0");

      if(!files.length) return;

      const take = files.slice(0, PHOTO_MAX_COUNT);
      for(const f of take){
        try{
          const p = await compressImageFileToDataUrl(f, PHOTO_MAX_SIDE, PHOTO_QUALITY);
          pendingPhotos.push({ name: f.name, type: p.type, dataUrl: p.dataUrl });
          $("photoCountPill") && ($("photoCountPill").textContent = "–§–æ—Ç–æ: " + pendingPhotos.length);
        }catch(e){
          console.warn("photo compress fail", e);
        }
      }

      if(files.length > PHOTO_MAX_COUNT){
        alert("–õ–∏–º–∏—Ç: –º–∞–∫—Å–∏–º—É–º " + PHOTO_MAX_COUNT + " —Ñ–æ—Ç–æ –Ω–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ.");
      }
    });
  }

  function readFileAsDataUrl(file){
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onerror = () => reject(new Error("FileReader error"));
      r.onload = () => resolve(String(r.result || ""));
      r.readAsDataURL(file);
    });
  }

  async function compressImageFileToDataUrl(file, maxSide=1280, quality=0.78){
    const src = await readFileAsDataUrl(file);

    // –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ image/* ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
    if(!String(file.type || "").startsWith("image/")){
      return { dataUrl: src, type: file.type || "application/octet-stream" };
    }

    // –≥—Ä—É–∑–∏–º –≤ Image
    const img = await new Promise((resolve, reject) => {
      const im = new Image();
      im.onload = () => resolve(im);
      im.onerror = () => reject(new Error("Image load error"));
      im.src = src;
    });

    const w = img.naturalWidth || img.width;
    const h = img.naturalHeight || img.height;

    // —Å—á–∏—Ç–∞–µ–º –º–∞—Å—à—Ç–∞–±
    let nw = w, nh = h;
    if(Math.max(w,h) > maxSide){
      const k = maxSide / Math.max(w,h);
      nw = Math.round(w * k);
      nh = Math.round(h * k);
    }

    const canvas = document.createElement("canvas");
    canvas.width = nw;
    canvas.height = nh;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, nw, nh);

    // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ JPEG (–æ–±—ã—á–Ω–æ –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ)
    const outType = "image/jpeg";
    const dataUrl = canvas.toDataURL(outType, quality);
    return { dataUrl, type: outType };
  }

  function photosHtmlForItem(item, contextLabel){
    const photos = Array.isArray(item?.photos) ? item.photos : [];
    if(!photos.length) return `<div class="hint" style="margin-top:8px;">–§–æ—Ç–æ –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ.</div>`;

    const thumbs = photos.map((p, idx) => `
      <div class="thumb" onclick="openPhotoModalById(${item.id}, ${idx}, '${escapeHtml(contextLabel)}')">
        <img src="${p.dataUrl}" alt="–§–æ—Ç–æ ${idx+1}">
      </div>
    `).join("");

    return `
      <div class="hint" style="margin-top:8px;"><b>–§–æ—Ç–æ:</b></div>
      <div class="thumbs">${thumbs}</div>
    `;
  }

  function openPhotoModal(list, index, title, sub){
    photoModalList = Array.isArray(list) ? list : [];
    photoModalIndex = Math.min(Math.max(Number(index)||0,0), Math.max(photoModalList.length-1,0));
    $("photoModalTitle").textContent = title || "–§–æ—Ç–æ";
    $("photoModalSub").textContent = sub || "";
    $("photoModal")?.classList.add("on");
    $("photoModal")?.setAttribute("aria-hidden","false");
    renderPhotoModal();
  }

  function openPhotoModalById(reportId, index, context){
    const item = reports.find(r => r.id === reportId);
    if(!item || !Array.isArray(item.photos) || !item.photos.length){
      alert("–§–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.");
      return;
    }
    const title = `–§–æ—Ç–æ –æ–±—Ä–∞—â–µ–Ω–∏—è #${item.id}`;
    const sub = context || "";
    openPhotoModal(item.photos, index, title, sub);
  }

  function closePhotoModal(){
    $("photoModal")?.classList.remove("on");
    $("photoModal")?.setAttribute("aria-hidden","true");
    photoModalList = [];
    photoModalIndex = 0;
  }

  function renderPhotoModal(){
    const img = $("photoModalImg");
    const ctr = $("photoModalCounter");
    if(!img || !ctr) return;

    if(!photoModalList.length){
      img.src = "";
      ctr.textContent = "0 / 0";
      return;
    }
    const p = photoModalList[photoModalIndex];
    img.src = p.dataUrl;
    ctr.textContent = `${photoModalIndex+1} / ${photoModalList.length}`;
  }

  function prevPhoto(){
    if(!photoModalList.length) return;
    photoModalIndex = (photoModalIndex - 1 + photoModalList.length) % photoModalList.length;
    renderPhotoModal();
  }
  function nextPhoto(){
    if(!photoModalList.length) return;
    photoModalIndex = (photoModalIndex + 1) % photoModalList.length;
    renderPhotoModal();
  }

  /* ====== –ú–ï–°–¢–û: —Ä–µ–∂–∏–º—ã ====== */
  function useMapPlace(){
    placeMode = "map";
    $("manualPlaceBlock")?.classList.add("hide");
    $("mapPlaceBlock")?.classList.remove("hide");
    if(!pickedLatLng) $("pickedCoordPill").textContent = "–¢–æ—á–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞";
  }

  function useManualPlace(){
    placeMode = "manual";
    pickedLatLng = null;
    $("manualPlaceBlock")?.classList.remove("hide");
    $("mapPlaceBlock")?.classList.add("hide");
    $("pickedCoordPill").textContent = "–¢–æ—á–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞";
  }

  function openPickMap(){
    $("pickModal")?.classList.add("on");
    $("pickModal")?.setAttribute("aria-hidden","false");
    initPickMapOnce();
    setTimeout(()=>{ pickMap?.invalidateSize(); }, 80);
    $("pickCatPill").textContent = "–ö–∞—Ç–µ–≥–æ—Ä–∏—è: " + catName(getChosenCategoryForMarker());
    refreshPickMarkerStyle();
  }

  function closePickMap(){
    $("pickModal")?.classList.remove("on");
    $("pickModal")?.setAttribute("aria-hidden","true");
  }

  function centerKZ(){
    if(!pickMap) return;
    pickMap.setView([48.0, 67.0], 5);
  }

  function getCssVarColorForCat(cat){
    const map = {
      roads: getComputedStyle(document.documentElement).getPropertyValue("--c-roads").trim(),
      light: getComputedStyle(document.documentElement).getPropertyValue("--c-light").trim(),
      trash: getComputedStyle(document.documentElement).getPropertyValue("--c-trash").trim(),
      water: getComputedStyle(document.documentElement).getPropertyValue("--c-water").trim(),
      other: getComputedStyle(document.documentElement).getPropertyValue("--c-other").trim()
    };
    return map[cat] || map.other;
  }

  function getChosenCategoryForMarker(){
    const type = $("type")?.value || "auto";
    if(type !== "auto") return type;
    const desc = ($("desc")?.value || "").trim();
    return aiClassify(desc);
  }

  function makeDotIcon(cat){
    const color = getCssVarColorForCat(cat);
    const html = `<div class="dot-marker"><div class="dot" style="background:${color}"></div></div>`;
    return L.divIcon({
      className: "",
      html,
      iconSize: [20,20],
      iconAnchor: [10,10]
    });
  }

  function initPickMapOnce(){
    if(pickMap) return;

    if(typeof L === "undefined"){
      setTimeout(initPickMapOnce, 60);
      return;
    }

    pickMap = L.map("pickMap", { zoomControl:true }).setView([51.169, 71.449], 11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "¬© OpenStreetMap"
    }).addTo(pickMap);

    pickMap.on("click", (e) => {
      pickedLatLng = e.latlng;

      const cat = getChosenCategoryForMarker();
      const icon = makeDotIcon(cat);

      if(!pickMarker){
        pickMarker = L.marker(e.latlng, { icon }).addTo(pickMap);
      }else{
        pickMarker.setLatLng(e.latlng);
        pickMarker.setIcon(icon);
      }

      $("pickCoord").textContent = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
      $("pickCatPill").textContent = "–ö–∞—Ç–µ–≥–æ—Ä–∏—è: " + catName(cat);
    });
  }

  function refreshPickMarkerStyle(){
    if(!pickMarker || !pickedLatLng || typeof L === "undefined") return;
    const cat = getChosenCategoryForMarker();
    pickMarker.setIcon(makeDotIcon(cat));
    $("pickCatPill").textContent = "–ö–∞—Ç–µ–≥–æ—Ä–∏—è: " + catName(cat);
  }

  function confirmPick(){
    if(!pickedLatLng){
      alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ.");
      return;
    }
    $("pickedCoordPill").textContent = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${pickedLatLng.lat.toFixed(5)}, ${pickedLatLng.lng.toFixed(5)}`;
    closePickMap();
  }

  async function submitReport(){
    if(!session || session.role !== "citizen"){
      alert("–ü–æ–¥–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ ¬´–ì—Ä–∞–∂–¥–∞–Ω–∏–Ω¬ª.");
      return;
    }

    const desc = ($("desc")?.value || "").trim();
    const type = $("type")?.value || "auto";
    if(!desc){ alert("–î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã."); return; }

    const cat = (type === "auto") ? aiClassify(desc) : type;
    $("aiTag") && ($("aiTag").textContent = "–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è: " + catName(cat));

    let region = "";
    let loc = "";
    let lat = null;
    let lng = null;

    if(placeMode === "map"){
      if(!pickedLatLng){
        alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ (–∫–Ω–æ–ø–∫–∞ ¬´–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É¬ª).");
        return;
      }
      lat = pickedLatLng.lat;
      lng = pickedLatLng.lng;
      region = "–ü–æ –∫–∞—Ä—Ç–µ";
      loc = `üìç ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
    }else{
      region = ($("region")?.value || "").trim();
      loc  = ($("loc")?.value || "").trim();
      if(!region){ alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω."); return; }
    }

    const id = makeUniqueId();

    // NEW: —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ—Ç–æ
    const photos = Array.isArray(pendingPhotos) ? pendingPhotos.slice(0, PHOTO_MAX_COUNT) : [];

    const item = {
      id,
      cat,
      region: region || "‚Äî",
      loc: (loc || "‚Äî"),
      desc,
      statusIndex: 0,
      citizen: session.name,
      createdAt: Date.now(),
      comments: [],
      lat, lng,
      photos
    };

    reports.unshift(item);

    // –ø—Ä–æ–±—É–µ–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å, –µ—Å–ª–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–æ ‚Äî –æ—Ç–∫–∞—Ç–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ
    try{
      saveAll();
    }catch(e){
      reports.shift();
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ: –ø–∞–º—è—Ç—å –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞.");
      return;
    }

    buildRegionFilter();
    renderAll();

    const res = $("result");
    if(res){
      res.innerHTML = `‚úÖ –û–±—Ä–∞—â–µ–Ω–∏–µ <b>#${id}</b> –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ. –†–µ–≥–∏–æ–Ω: <b>${escapeHtml(item.region)}</b>. –°—Ç–∞—Ç—É—Å: ${statusBadge(0)}<br>${photos.length ? `üì∑ –§–æ—Ç–æ: <b>${photos.length}</b>` : ``}`;
    }

    $("trackId") && ($("trackId").value = id);

    // –æ—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    $("desc") && ($("desc").value = "");
    $("loc") && ($("loc").value = "");
    $("type") && ($("type").value = "auto");
    $("region") && ($("region").value = "");
    pickedLatLng = null;
    $("pickedCoordPill").textContent = "–¢–æ—á–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞";

    // –æ—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ç–æ
    pendingPhotos = [];
    $("photoCountPill") && ($("photoCountPill").textContent = "–§–æ—Ç–æ: 0");
    const inp = $("photos");
    if(inp) inp.value = "";
  }

  function track(){
    const id = Number(($("trackId")?.value || "").trim());
    const out = $("trackOut");
    if(!out) return;

    if(!id){ out.innerHTML = "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –æ–±—Ä–∞—â–µ–Ω–∏—è."; return; }
    const item = reports.find(r=>r.id===id);
    if(!item){ out.innerHTML = "–ù–µ –Ω–∞–π–¥–µ–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–æ–º–µ—Ä."; return; }

    const lastComment = item.comments?.length ? item.comments[item.comments.length - 1] : null;

    out.innerHTML = `
      üìå –û–±—Ä–∞—â–µ–Ω–∏–µ <b>#${item.id}</b><br>
      –ö–∞—Ç–µ–≥–æ—Ä–∏—è: <b>${catName(item.cat)}</b><br>
      –†–µ–≥–∏–æ–Ω: <b>${escapeHtml(item.region)}</b><br>
      –õ–æ–∫–∞—Ü–∏—è: <b>${escapeHtml(item.loc)}</b><br>
      –ó–∞—è–≤–∏—Ç–µ–ª—å: <b>${escapeHtml(item.citizen)}</b><br>
      –°—Ç–∞—Ç—É—Å: ${statusBadge(item.statusIndex)}<br>

      ${photosHtmlForItem(item, "–¢—Ä–µ–∫–∏–Ω–≥")}

      ${lastComment ? `
        <div class="panel">
          <b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:</b><br>
          <div style="margin-top:6px;">${escapeHtml(lastComment.text)}</div>
          <div class="hint" style="margin-top:6px;">${new Date(lastComment.at).toLocaleString("ru-RU")}</div>
        </div>
      ` : `<div class="hint" style="margin-top:8px;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –ø–æ–∫–∞ –Ω–µ—Ç.</div>`}
    `;
  }

  function buildRegionFilter(){
    const sel = $("regionFilter");
    if(!sel) return;

    const current = sel.value || "any";
    const regions = Array.from(new Set(reports.map(r => r.region).filter(x => x && x !== "‚Äî"))).sort((a,b)=>a.localeCompare(b,"ru"));

    sel.innerHTML = `<option value="any">–í—Å–µ —Ä–µ–≥–∏–æ–Ω—ã</option>` + regions.map(r=>`<option value="${escapeHtml(r)}">${escapeHtml(r)}</option>`).join("");
    if(regions.includes(current)) sel.value = current;
    else sel.value = "any";
  }

  function setStatus(id, value){
    if(!session || session.role !== "gov"){
      alert("–ú–µ–Ω—è—Ç—å —Å—Ç–∞—Ç—É—Å –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ —Ä–æ–ª—å ¬´–ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ¬ª.");
      return;
    }
    const item = reports.find(r=>r.id===id);
    if(!item) return;
    const idx = Number(value);
    if(Number.isNaN(idx) || idx < 0 || idx >= STATUS.length) return;

    item.statusIndex = idx;
    saveAll();
    renderAll();
  }

  function toggleCommentPanel(id){
    openCommentId = (openCommentId === id) ? null : id;
    renderAll();
    if(openCommentId !== null){
      setTimeout(()=>{ document.getElementById("cmt-"+id)?.focus(); }, 50);
    }
  }

  function addComment(id){
    if(!session || session.role !== "gov"){
      alert("–ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ —Ä–æ–ª—å ¬´–ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ¬ª.");
      return;
    }
    const ta = document.getElementById("cmt-"+id);
    if(!ta) return;

    const text = ta.value.trim();
    if(!text){ alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π."); return; }

    const item = reports.find(r=>r.id===id);
    if(!item) return;

    if(!Array.isArray(item.comments)) item.comments = [];
    item.comments.push({ by: session.name, text, at: Date.now() });

    ta.value = "";
    saveAll();
    renderAll();
  }

  function updateRegion(id){
    if(!session || session.role !== "citizen"){
      alert("–ú–µ–Ω—è—Ç—å —Ä–µ–≥–∏–æ–Ω –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ –≥—Ä–∞–∂–¥–∞–Ω–∏–Ω.");
      return;
    }
    const item = reports.find(r=>r.id===id);
    if(!item) return;
    if(item.citizen !== session.name){
      alert("–ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —Ä–µ–≥–∏–æ–Ω —Ç–æ–ª—å–∫–æ —É —Å–≤–æ–∏—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π.");
      return;
    }
    const sel = document.getElementById("myRegion-"+id);
    if(!sel) return;
    const region = (sel.value || "").trim();
    if(!region){ alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω."); return; }

    item.region = region;
    saveAll();
    buildRegionFilter();
    renderAll();
  }

  function getRegionOptionsHtml(selected){
    const regions = [
      "–ê—Å—Ç–∞–Ω–∞","–ê–ª–º–∞—Ç—ã","–®—ã–º–∫–µ–Ω—Ç",
      "–ê–∫–º–æ–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","–ê–∫—Ç—é–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","–ê–ª–º–∞—Ç–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","–ê—Ç—ã—Ä–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
      "–í–æ—Å—Ç–æ—á–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","–ñ–∞–º–±—ã–ª—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","–ñ–µ—Ç—ã—Å—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","–ó–∞–ø–∞–¥–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
      "–ö–∞—Ä–∞–≥–∞–Ω–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","–ö–æ—Å—Ç–∞–Ω–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","–ö—ã–∑—ã–ª–æ—Ä–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","–ú–∞–Ω–≥–∏—Å—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
      "–ü–∞–≤–ª–æ–¥–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","–°–µ–≤–µ—Ä–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","–¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
      "–£–ª—ã—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","–ê–±–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"
    ];
    return regions.map(r => `<option ${r===selected ? "selected" : ""}>${escapeHtml(r)}</option>`).join("");
  }

  /* ====== ADMIN VIEW: –∫–∞—Ä—Ç–∞ ====== */
  function setAdminView(v){
    adminView = v;
    $("btnAdminTable")?.classList.toggle("on", v === "table");
    $("btnAdminMap")?.classList.toggle("on", v === "map");

    $("adminTableWrap")?.classList.toggle("hide", v !== "table");
    $("adminMapWrap")?.classList.toggle("hide", v !== "map");

    if(v === "map"){
      initAdminMapOnce();
      setTimeout(()=>adminMap?.invalidateSize(), 80);
      renderAdminMapMarkers();
    }
  }

  function initAdminMapOnce(){
    if(adminMap) return;

    if(typeof L === "undefined"){
      setTimeout(initAdminMapOnce, 60);
      return;
    }

    adminMap = L.map("adminMap", { zoomControl:true }).setView([48.0, 67.0], 5);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "¬© OpenStreetMap"
    }).addTo(adminMap);

    adminLayer = L.layerGroup().addTo(adminMap);
  }

  function shortDesc(s, max=60){
    const t = String(s || "").trim().replace(/\s+/g," ");
    if(t.length <= max) return t;
    return t.slice(0, max-1) + "‚Ä¶";
  }

  function filteredReportsForAdmin(){
    const catF = $("filter")?.value || "all";
    const stF  = $("statusFilter")?.value || "any";
    const regF = $("regionFilter")?.value || "any";

    let list = [...reports];
    if(catF !== "all") list = list.filter(r => r.cat === catF);
    if(stF !== "any") list = list.filter(r => String(r.statusIndex) === stF);
    if(regF !== "any") list = list.filter(r => r.region === regF);
    return list;
  }

  function renderAdminMapMarkers(){
    if(!adminMap || !adminLayer) return;
    adminLayer.clearLayers();

    const list = filteredReportsForAdmin().filter(r => typeof r.lat === "number" && typeof r.lng === "number");

    list.forEach(r => {
      const icon = makeDotIcon(r.cat);
      const m = L.marker([r.lat, r.lng], { icon }).addTo(adminLayer);

      m.bindTooltip(
        `<div><b>#${r.id}</b> ¬∑ ${catName(r.cat)}<br><span style="opacity:.85">${escapeHtml(shortDesc(r.desc))}</span></div>`,
        { className:"mytip", direction:"top", offset:[0,-10], sticky:true }
      );

      const photos = Array.isArray(r.photos) ? r.photos : [];
      const photoBlock = photos.length ? `
        <div style="margin-top:10px;">
          <div style="font-weight:900; margin-bottom:6px;">–§–æ—Ç–æ (${photos.length})</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            ${photos.map((p, idx)=>`
              <div style="width:88px;height:66px;border-radius:12px;overflow:hidden;border:1px solid var(--line);cursor:pointer;"
                   onclick="openPhotoModalById(${r.id}, ${idx}, '–†–µ–µ—Å—Ç—Ä ¬∑ –∫–∞—Ä—Ç–∞')">
                <img src="${p.dataUrl}" style="width:100%;height:100%;object-fit:cover;display:block;" alt="–§–æ—Ç–æ">
              </div>
            `).join("")}
          </div>
        </div>
      ` : `<div style="margin-top:10px; font-size:12px; color:var(--muted);">–§–æ—Ç–æ: –Ω–µ—Ç</div>`;

      m.bindPopup(`
        <div style="font-weight:900;margin-bottom:6px;">#${r.id} ¬∑ ${catName(r.cat)}</div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px;">${new Date(r.createdAt).toLocaleString("ru-RU")}</div>
        <div style="margin-bottom:6px;"><b>–°—Ç–∞—Ç—É—Å:</b> ${STATUS[r.statusIndex]}</div>
        <div style="margin-bottom:6px;"><b>–†–µ–≥–∏–æ–Ω:</b> ${escapeHtml(r.region)}</div>
        <div style="margin-bottom:6px;"><b>–õ–æ–∫–∞—Ü–∏—è:</b> ${escapeHtml(r.loc)}</div>
        <div style="font-size:12px;line-height:1.35;">${escapeHtml(r.desc)}</div>
        ${photoBlock}
      `);
    });

    if(list.length){
      const bounds = L.latLngBounds(list.map(r => [r.lat, r.lng]));
      adminMap.fitBounds(bounds.pad(0.25));
    }
  }

  function renderAll(){
    const total = reports.length;
    const active = reports.filter(r => r.statusIndex >= 1 && r.statusIndex <= 2).length;
    const done = reports.filter(r => r.statusIndex === 3).length;

    $("kpiTotal") && ($("kpiTotal").textContent = total);
    $("kpiActive") && ($("kpiActive").textContent = active);
    $("kpiDone") && ($("kpiDone").textContent = done);

    $("myUser") && ($("myUser").textContent = session?.name || "‚Äî");

    if(session?.role === "gov" && adminView === "map"){
      renderAdminMapMarkers();
    }

    const myList = $("myList");
    if(myList){
      if(!session || session.role !== "citizen"){
        myList.innerHTML = "‚Äî";
      }else{
        const mine = reports.filter(r => r.citizen === session.name);
        myList.innerHTML = mine.length ? mine.map(r=>{
          const last = r.comments?.length ? r.comments[r.comments.length - 1] : null;
          const regionOptions = getRegionOptionsHtml(r.region);

          return `
            <div class="card">
              <div class="row" style="justify-content:space-between;">
                <div><b>#${r.id}</b> ¬∑ ${catName(r.cat)}</div>
                <div>${statusBadge(r.statusIndex)}</div>
              </div>

              <div class="hint" style="margin-top:8px;"><b>–õ–æ–∫–∞—Ü–∏—è:</b> ${escapeHtml(r.loc)}</div>
              <div class="hint"><b>–†–µ–≥–∏–æ–Ω:</b></div>

              <div class="row" style="margin-top:6px;">
                <select id="myRegion-${r.id}" style="max-width:360px;">${regionOptions}</select>
                <button class="mini-btn" onclick="updateRegion(${r.id})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–≥–∏–æ–Ω</button>
              </div>

              <div style="margin-top:10px;">${escapeHtml(r.desc)}</div>

              ${photosHtmlForItem(r, "–ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è")}

              ${last ? `
                <div class="panel">
                  <b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:</b>
                  <div style="margin-top:6px;">${escapeHtml(last.text)}</div>
                  <div class="hint" style="margin-top:6px;">${new Date(last.at).toLocaleString("ru-RU")}</div>
                </div>
              ` : `<div class="hint" style="margin-top:8px;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –ø–æ–∫–∞ –Ω–µ—Ç.</div>`}
            </div>
          `;
        }).join("") : "–ù–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π.";
      }
    }

    const tbody = $("tbody");
    if(tbody){
      if(!session || session.role !== "gov"){
        tbody.innerHTML = "";
      }else{
        const list = filteredReportsForAdmin();

        tbody.innerHTML = list.length ? list.map(r=>{
          const last = r.comments?.length ? r.comments[r.comments.length - 1] : null;

          const statusOptions = STATUS.map((s, i)=>
            `<option value="${i}" ${i===r.statusIndex ? "selected" : ""}>${s}</option>`
          ).join("");

          const photoCount = Array.isArray(r.photos) ? r.photos.length : 0;
          const photoBtn = photoCount
            ? `<button class="mini-btn" onclick="openPhotoModalById(${r.id}, 0, '–†–µ–µ—Å—Ç—Ä ¬∑ —Ç–∞–±–ª–∏—Ü–∞')">–§–æ—Ç–æ (${photoCount})</button>`
            : `<button class="mini-btn" onclick="alert('–§–æ—Ç–æ –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ.')">–§–æ—Ç–æ (0)</button>`;

          return `
            <tr>
              <td>
                <b>${r.id}</b>
                <div class="hint">${new Date(r.createdAt).toLocaleString("ru-RU")}</div>
              </td>
              <td>${catName(r.cat)}</td>
              <td>${escapeHtml(r.citizen)}</td>
              <td class="wrap">${escapeHtml(r.region)}</td>
              <td class="wrap">${escapeHtml(r.loc)}</td>
              <td>
                <select class="status-select" onchange="setStatus(${r.id}, this.value)">
                  ${statusOptions}
                </select>
                <div style="margin-top:8px;">${statusBadge(r.statusIndex)}</div>
              </td>
              <td>
                <div class="row">
                  ${photoBtn}
                  <button class="mini-btn" onclick="toggleCommentPanel(${r.id})">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π${last ? " ‚Ä¢" : ""}</button>
                </div>

                ${openCommentId === r.id ? `
                  <div class="panel">
                    <textarea id="cmt-${r.id}" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –≥—Ä–∞–∂–¥–∞–Ω–∏–Ω–∞..."></textarea>
                    <div class="row" style="margin-top:8px;">
                      <button class="btn" onclick="addComment(${r.id})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                      <button class="btn2" onclick="toggleCommentPanel(${r.id})">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                  </div>
                ` : ``}
              </td>
            </tr>
          `;
        }).join("") : `<tr><td colspan="7" class="hint">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º.</td></tr>`;
      }
    }
  }
</script>
</body>
</html>
