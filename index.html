<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Citizen Portal</title>

  <!-- FAVICON -->
  <link rel="icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">

  <style>
    :root{
      --bg:#F2F4F7;
      --card:#ffffff;
      --text:#102A43;
      --muted:#52606D;
      --line:#E4E7EB;
      --nav:#102A43;
      --nav2:#243B53;
      --brand:#0B3C5D;
      --accent:#1E88E5;
      --shadow: 0 8px 24px rgba(16,42,67,0.08);
      --radius: 14px;
    }
    [data-theme="dark"]{
      --bg:#0B1020;
      --card:#0F172A;
      --text:#E6EEF8;
      --muted:#A7B4C6;
      --line:#20304A;
      --nav:#0E1830;
      --nav2:#142240;
      --brand:#0A1F3A;
      --accent:#4DA3FF;
      --shadow: 0 10px 28px rgba(0,0,0,0.35);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: -apple-system, system-ui, Segoe UI, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .topbar{
      height:64px;
      background: var(--brand);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 18px;
      position:sticky;
      top:0;
      z-index:50;
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
      font-weight:800;
      letter-spacing:.2px;
    }
    .logo{
      width:36px;height:36px;border-radius:10px;
      background: rgba(255,255,255,0.14);
      display:grid;place-items:center;
      font-weight:900;
    }
    .top-right{ display:flex; align-items:center; gap:10px; font-size:13px; opacity:.95; }
    .chip{
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.22);
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
    }

    .layout{ display:grid; grid-template-columns: 260px 1fr; min-height: calc(100vh - 64px); }

    .sidebar{
      background: var(--nav);
      color:#D9E2EC;
      padding:16px 12px;
      position:sticky;
      top:64px;
      height: calc(100vh - 64px);
      overflow:auto;
    }
    .navtitle{
      font-size:12px; opacity:.85; padding:8px 10px;
      text-transform: uppercase; letter-spacing:.08em;
    }
    .navitem{
      display:flex; gap:10px; align-items:center;
      padding:12px 12px; border-radius:12px;
      cursor:pointer; user-select:none;
      margin:4px 0; transition:.15s;
    }
    .navitem:hover{ background: var(--nav2); }
    .navitem.active{ background: rgba(30,136,229,0.18); border: 1px solid rgba(30,136,229,0.35); }
    .navicon{ width:24px; text-align:center; }

    .sidebar-actions{ padding:12px; }
    .sidebar-bottom{ margin-top:8px; padding:12px; border-top: 1px solid rgba(217,226,236,0.12); }

    .theme-toggle{
      width:100%;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border-radius:14px;
      cursor:pointer; user-select:none;
      border:1px solid rgba(217,226,236,0.14);
      background: rgba(255,255,255,0.06);
      color:#D9E2EC;
    }
    .theme-icons{ display:flex; gap:8px; font-size:18px; align-items:center; }
    .theme-icons span{ opacity:.55; transition:.15s; }
    .theme-icons .on{ opacity:1; transform: scale(1.05); }

    .main{ padding:18px; }
    .grid{ display:grid; grid-template-columns: 1.2fr 0.8fr; gap:16px; }
    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
      .sidebar{ position:relative; top:0; height:auto; }
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      margin-bottom:16px;
    }

    h2{ margin:0 0 10px; font-size:18px; }
    .muted{ color: var(--muted); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .spacer{ height:10px; }

    label{
      display:block; margin:10px 0 6px;
      font-size:13px; color: var(--muted); font-weight:600;
    }
    input, textarea, select{
      width:100%;
      padding:12px;
      border-radius:12px;
      border: 1px solid var(--line);
      background:#fff;
      color: var(--text);
      outline:none;
    }
    [data-theme="dark"] input,
    [data-theme="dark"] textarea,
    [data-theme="dark"] select{ background:#0B1224; }
    textarea{ min-height:110px; resize:vertical; }

    .btn{
      padding:12px 14px;
      border:0;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      background: var(--accent);
      color:#fff;
    }
    .btn2{
      padding:12px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      background:transparent;
      color: var(--text);
      border: 1px solid var(--line);
    }
    .btn-danger{
      width:100%;
      background:transparent;
      border:1px solid #ffccd5;
      color:#a61b1b;
      font-weight:800;
      border-radius:12px;
      padding:12px 14px;
      cursor:pointer;
    }
    [data-theme="dark"] .btn-danger{ border-color:#5a1b1b; color:#ffb4b4; }

    .pill{
      display:inline-flex;
      padding:6px 10px;
      border-radius:999px;
      border: 1px solid var(--line);
      background:transparent;
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
    }

    .kpi{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .kpi .box{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:transparent;
    }
    .kpi .num{ font-size:20px; font-weight:900; }
    .kpi .lab{ font-size:12px; color: var(--muted); margin-top:4px; }

    .table-wrap{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:auto;
      background:transparent;
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width: 1020px;
    }
    th, td{
      padding:10px;
      border-bottom:1px solid var(--line);
      text-align:left;
      font-size:13px;
      vertical-align:top;
      white-space:nowrap;
    }
    td.wrap{ white-space:normal; }
    th{
      position:sticky;
      top:0;
      background:rgba(247,249,251,0.92);
      backdrop-filter: blur(6px);
      font-size:12px;
      color: var(--muted);
      text-transform:uppercase;
      letter-spacing:.06em;
      z-index:5;
    }
    [data-theme="dark"] th{ background: rgba(255,255,255,0.06); }

    .badge{
      display:inline-flex;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      border: 1px solid var(--line);
      background:transparent;
      color: var(--muted);
      white-space:nowrap;
    }
    .b-new{ border-color:#2b5fa2; background:rgba(30,136,229,0.16); color:#9fd0ff; }
    .b-proc{ border-color:#a86a1a; background:rgba(239,108,0,0.12); color:#ffd2a6; }
    .b-dept{ border-color:#334a6b; background:rgba(167,180,198,0.10); color:#cbd6e6; }
    .b-done{ border-color:#1c6b3a; background:rgba(46,125,50,0.12); color:#b7f0c0; }

    .hint{ font-size:12px; color: var(--muted); margin-top:8px; line-height:1.35; }
    .hide{ display:none !important; }

    .mini-btn{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background:transparent;
      cursor:pointer;
      font-weight:800;
      color: var(--text);
    }

    .status-select{
      border-radius:999px;
      padding:8px 10px;
      border:1px solid var(--line);
      font-weight:900;
      font-size:12px;
      background:transparent;
      width:auto;
    }

    .panel{
      margin-top:10px;
      border:1px dashed var(--line);
      border-radius:12px;
      padding:10px;
      background: rgba(255,255,255,0.04);
    }
    .panel textarea{ min-height:70px; }

    .footer{
      margin-top:16px;
      padding:14px 16px;
      border:1px solid var(--line);
      background:transparent;
      border-radius:14px;
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
    }
    .footer strong{ color: var(--text); }
    .footer .links{ display:flex; flex-wrap:wrap; gap:10px; margin-top:8px; }
    .footer a{ color: var(--accent); text-decoration:none; font-weight:700; }
    .footer a:hover{ text-decoration:underline; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo">SC</div>
      <div>
        Smart Citizen Portal<br>
        <span style="font-weight:600; font-size:12px; opacity:.9;">–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –æ–±—Ä–∞—â–µ–Ω–∏–π –≥—Ä–∞–∂–¥–∞–Ω</span>
      </div>
    </div>
    <div class="top-right">
      <span class="chip" id="today"></span>
      <span class="chip" id="sessionChip">–ì–æ—Å—Ç—å</span>
    </div>
  </div>

  <div class="layout">
    <aside class="sidebar">
      <div class="navtitle">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>

      <div class="navitem active" id="nav-auth" onclick="go('auth')"><div class="navicon">üîê</div><div>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div></div>
      <div class="navitem" id="nav-dashboard" onclick="go('dashboard')"><div class="navicon">üè†</div><div>–ì–ª–∞–≤–Ω–∞—è</div></div>
      <div class="navitem" id="nav-report" onclick="go('report')"><div class="navicon">‚ûï</div><div>–ü–æ–¥–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ</div></div>
      <div class="navitem" id="nav-my" onclick="go('my')"><div class="navicon">üìÇ</div><div>–ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</div></div>
      <div class="navitem" id="nav-track" onclick="go('track')"><div class="navicon">üîé</div><div>–¢—Ä–µ–∫–∏–Ω–≥ –ø–æ –Ω–æ–º–µ—Ä—É</div></div>

      <div class="navtitle" style="margin-top:8px;">–î–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>
      <div class="navitem" id="nav-admin" onclick="go('admin')"><div class="navicon">üèõÔ∏è</div><div>–†–µ–µ—Å—Ç—Ä –æ–±—Ä–∞—â–µ–Ω–∏–π</div></div>

      <div class="navitem" id="nav-help" onclick="go('help')"><div class="navicon">‚ùì</div><div>–ü–æ–º–æ—â—å</div></div>

      <div class="sidebar-actions">
        <button class="btn-danger" onclick="logout()">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
      </div>

      <div class="sidebar-bottom">
        <div class="theme-toggle" onclick="toggleTheme()" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
          <div style="font-weight:800;">–¢–µ–º–∞</div>
          <div class="theme-icons" aria-hidden="true">
            <span id="icoSun">‚òÄÔ∏è</span>
            <span id="icoMoon">üåô</span>
          </div>
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="grid">
        <div>
          <!-- AUTH -->
          <section class="card" id="tab-auth">
            <h2>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <div class="muted">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å: <b>–ì—Ä–∞–∂–¥–∞–Ω–∏–Ω</b> –∏–ª–∏ <b>–ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ</b>.</div>

            <div class="spacer"></div>

            <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
            <input id="authName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: erasyl" />

            <label>–†–æ–ª—å</label>
            <select id="authRole">
              <option value="citizen">–ì—Ä–∞–∂–¥–∞–Ω–∏–Ω</option>
              <option value="gov">–ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ (–æ–ø–µ—Ä–∞—Ç–æ—Ä)</option>
            </select>

            <div id="govPassWrap" class="hide">
              <label>–ü–∞—Ä–æ–ª—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</label>
              <input id="govPass" type="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            </div>

            <div class="row" style="margin-top:10px;">
              <button class="btn" onclick="login()">–í–æ–π—Ç–∏</button>
              <span class="pill" id="authInfo">–°—Ç–∞—Ç—É—Å: –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span>
            </div>
          </section>

          <!-- DASH -->
          <section class="card hide" id="tab-dashboard">
            <h2>–ì–ª–∞–≤–Ω–∞—è</h2>
            <div class="muted">–°–≤–æ–¥–∫–∞ –∏ –±—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è.</div>

            <div class="spacer"></div>

            <div class="kpi">
              <div class="box"><div class="num" id="kpiTotal">0</div><div class="lab">–í—Å–µ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏–π</div></div>
              <div class="box"><div class="num" id="kpiActive">0</div><div class="lab">–í —Ä–∞–±–æ—Ç–µ</div></div>
              <div class="box"><div class="num" id="kpiDone">0</div><div class="lab">–†–µ—à–µ–Ω–æ</div></div>
            </div>

            <div class="spacer"></div>

            <div class="row">
              <button class="btn2" onclick="go('report')">–ü–æ–¥–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ</button>
              <button class="btn2" onclick="go('track')">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
            </div>
          </section>

          <!-- REPORT -->
          <section class="card hide" id="tab-report">
            <h2>–ü–æ–¥–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ</h2>
            <div class="muted">–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –∏ –º–µ—Å—Ç–æ. <b>–†–µ–≥–∏–æ–Ω –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω.</b></div>

            <label>–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã</label>
            <textarea id="desc" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù–∞ —É–ª–∏—Ü–µ –ê–±–∞—è –±–æ–ª—å—à–∞—è —è–º–∞ –Ω–∞ –¥–æ—Ä–æ–≥–µ..."></textarea>

            <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <select id="type">
              <option value="auto">–ê–≤—Ç–æ (–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)</option>
              <option value="roads">–î–æ—Ä–æ–≥–∏</option>
              <option value="light">–û—Å–≤–µ—â–µ–Ω–∏–µ</option>
              <option value="trash">–ú—É—Å–æ—Ä</option>
              <option value="water">–í–æ–¥–∞ / –ø–æ–¥—Ç–æ–ø–ª–µ–Ω–∏—è</option>
              <option value="other">–î—Ä—É–≥–æ–µ</option>
            </select>

            <label>–†–µ–≥–∏–æ–Ω</label>
            <select id="region">
              <option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω ‚Äî</option>
              <option>–ê—Å—Ç–∞–Ω–∞</option>
              <option>–ê–ª–º–∞—Ç—ã</option>
              <option>–®—ã–º–∫–µ–Ω—Ç</option>
              <option>–ê–∫–º–æ–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
              <option>–ê–∫—Ç—é–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
              <option>–ê–ª–º–∞—Ç–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
              <option>–ê—Ç—ã—Ä–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
              <option>–í–æ—Å—Ç–æ—á–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
              <option>–ñ–∞–º–±—ã–ª—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
              <option>–ñ–µ—Ç—ã—Å—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
              <option>–ó–∞–ø–∞–¥–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
              <option>–ö–∞—Ä–∞–≥–∞–Ω–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
              <option>–ö–æ—Å—Ç–∞–Ω–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
              <option>–ö—ã–∑—ã–ª–æ—Ä–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
              <option>–ú–∞–Ω–≥–∏—Å—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
              <option>–ü–∞–≤–ª–æ–¥–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
              <option>–°–µ–≤–µ—Ä–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
              <option>–¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
              <option>–£–ª—ã—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
              <option>–ê–±–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            </select>

            <label>–õ–æ–∫–∞—Ü–∏—è (—Ç–µ–∫—Å—Ç)</label>
            <input id="loc" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –æ—Ä–∏–µ–Ω—Ç–∏—Ä" />

            <div class="row" style="margin-top:12px;">
              <button class="btn" onclick="submitReport()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
              <span class="pill" id="aiTag">–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è: ‚Äî</span>
            </div>

            <div id="result" class="hint"></div>
          </section>

          <!-- MY -->
          <section class="card hide" id="tab-my">
            <h2>–ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</h2>
            <div class="muted">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <b id="myUser"></b>. –†–µ–≥–∏–æ–Ω –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å.</div>
            <div class="spacer"></div>
            <div id="myList" class="hint">‚Äî</div>
          </section>

          <!-- TRACK -->
          <section class="card hide" id="tab-track">
            <h2>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ –Ω–æ–º–µ—Ä—É</h2>

            <label>–ù–æ–º–µ—Ä –æ–±—Ä–∞—â–µ–Ω–∏—è</label>
            <input id="trackId" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1024" />

            <div class="row" style="margin-top:12px;">
              <button class="btn" onclick="track()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
              <button class="btn2" onclick="go('dashboard')">–ù–∞–∑–∞–¥</button>
            </div>

            <div id="trackOut" class="hint"></div>
          </section>

          <!-- ADMIN -->
          <section class="card hide" id="tab-admin">
            <h2>–†–µ–µ—Å—Ç—Ä –æ–±—Ä–∞—â–µ–Ω–∏–π</h2>

            <div class="row" style="margin:12px 0;">
              <label style="margin:0;">–§–∏–ª—å—Ç—Ä:</label>
              <select id="filter" onchange="renderAll()" style="max-width:220px;">
                <option value="all">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                <option value="roads">–î–æ—Ä–æ–≥–∏</option>
                <option value="light">–û—Å–≤–µ—â–µ–Ω–∏–µ</option>
                <option value="trash">–ú—É—Å–æ—Ä</option>
                <option value="water">–í–æ–¥–∞/–ø–æ–¥—Ç–æ–ø–ª–µ–Ω–∏—è</option>
                <option value="other">–î—Ä—É–≥–æ–µ</option>
              </select>

              <select id="statusFilter" onchange="renderAll()" style="max-width:220px;">
                <option value="any">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                <option value="0">–ü—Ä–∏–Ω—è—Ç–æ</option>
                <option value="1">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
                <option value="2">–ü–µ—Ä–µ–¥–∞–Ω–æ –≤ –æ—Ç–¥–µ–ª</option>
                <option value="3">–†–µ—à–µ–Ω–æ</option>
              </select>

              <select id="regionFilter" onchange="renderAll()" style="max-width:260px;">
                <option value="any">–í—Å–µ —Ä–µ–≥–∏–æ–Ω—ã</option>
              </select>
            </div>

            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th style="min-width:90px;">ID</th>
                    <th style="min-width:140px;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                    <th style="min-width:140px;">–ì—Ä–∞–∂–¥–∞–Ω–∏–Ω</th>
                    <th style="min-width:170px;">–†–µ–≥–∏–æ–Ω</th>
                    <th style="min-width:220px;">–õ–æ–∫–∞—Ü–∏—è</th>
                    <th style="min-width:190px;">–°—Ç–∞—Ç—É—Å</th>
                    <th style="min-width:170px;">–î–µ–π—Å—Ç–≤–∏—è</th>
                  </tr>
                </thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>
          </section>

          <!-- HELP -->
          <section class="card hide" id="tab-help">
            <h2>–ü–æ–º–æ—â—å</h2>
            <div class="hint">
              ‚Ä¢ –í–æ–π–¥–∏—Ç–µ –∫–∞–∫ –≥—Ä–∞–∂–¥–∞–Ω–∏–Ω ‚Üí ‚Äú–ü–æ–¥–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ‚Äù.<br>
              ‚Ä¢ –†–µ–≥–∏–æ–Ω –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω.<br>
              ‚Ä¢ –ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ –º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ —Å–ø–∏—Å–æ–∫.
            </div>
          </section>

          <div class="footer">
            <strong>–û —Å–µ—Ä–≤–∏—Å–µ Smart Citizen</strong><br>
            –ï–¥–∏–Ω—ã–π –ø–æ—Ä—Ç–∞–ª –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏–π –∂–∏—Ç–µ–ª–µ–π: —Ñ–∏–∫—Å–∏—Ä—É–π—Ç–µ –ø—Ä–æ–±–ª–µ–º—É, –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Å—Ç–∞—Ç—É—Å, –ø–æ–≤—ã—à–∞–π—Ç–µ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã —Å–ª—É–∂–±.
            <div class="links">
              <a href="javascript:void(0)" onclick="go('help')">–ü–æ–º–æ—â—å</a>
              <a href="javascript:void(0)" onclick="go('report')">–ü–æ–¥–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ</a>
              <a href="javascript:void(0)" onclick="go('track')">–¢—Ä–µ–∫–∏–Ω–≥</a>
            </div>
          </div>
        </div>

        <div></div>
      </div>
    </main>
  </div>

<script>
  const STORAGE_KEY = "smartCitizenPortal_v2";
  const USERS_KEY   = "smartCitizenUsers_v1";
  const THEME_KEY   = "smartCitizenTheme_v1";
  const SESSION_KEY = "smartCitizenSession_v1";

  const GOV_PASSWORD = "z123456!";

  const STATUS = ["–ü—Ä–∏–Ω—è—Ç–æ", "–í –æ–±—Ä–∞–±–æ—Ç–∫–µ", "–ü–µ—Ä–µ–¥–∞–Ω–æ –≤ –æ—Ç–¥–µ–ª", "–†–µ—à–µ–Ω–æ"];
  let reports = [];
  let users = [];
  let session = null;
  let openCommentId = null;

  startClock();
  applySavedTheme();
  loadAll();
  restoreSession();
  hookAuthRoleUI();
  buildRegionFilter();
  renderAll();
  go(session ? "dashboard" : "auth");

  window.addEventListener("storage", (e) => {
    if (e.key === STORAGE_KEY || e.key === USERS_KEY) {
      loadAll();
      buildRegionFilter();
      renderAll();
    }
    if (e.key === THEME_KEY) applySavedTheme();
  });

  function $(id){ return document.getElementById(id); }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function startClock(){
    const el = $("today");
    const tick = () => { if(el) el.textContent = new Date().toLocaleString("ru-RU"); };
    tick();
    setInterval(tick, 1000);
  }

  function applySavedTheme(){
    const t = localStorage.getItem(THEME_KEY) || "light";
    document.documentElement.setAttribute("data-theme", t);
    $("icoSun")?.classList.toggle("on", t === "light");
    $("icoMoon")?.classList.toggle("on", t === "dark");
  }
  function toggleTheme(){
    const cur = document.documentElement.getAttribute("data-theme") || "light";
    const next = (cur === "dark") ? "light" : "dark";
    localStorage.setItem(THEME_KEY, next);
    applySavedTheme();
  }

  function loadAll(){
    try{ reports = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
    catch{ reports = []; }

    try{ users = JSON.parse(localStorage.getItem(USERS_KEY) || "[]"); }
    catch{ users = []; }

    reports.forEach(r => {
      if(!Array.isArray(r.comments)) r.comments = [];
      if(typeof r.statusIndex !== "number") r.statusIndex = 0;
      if(!r.region) r.region = "‚Äî";
      if(!r.loc) r.loc = "‚Äî";
    });
  }

  function saveAll(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(reports));
    localStorage.setItem(USERS_KEY, JSON.stringify(users));
  }

  function setSession(s){
    session = s;
    if(session) localStorage.setItem(SESSION_KEY, JSON.stringify(session));
    else localStorage.removeItem(SESSION_KEY);
    updateSessionUI();
  }

  function restoreSession(){
    try{
      const s = JSON.parse(localStorage.getItem(SESSION_KEY) || "null");
      session = (s && s.name && s.role) ? s : null;
    }catch{ session = null; }
    updateSessionUI();
  }

  function hookAuthRoleUI(){
    const roleSel = $("authRole");
    if(roleSel) roleSel.addEventListener("change", syncGovPasswordUI);
    syncGovPasswordUI();
  }

  function syncGovPasswordUI(){
    const role = $("authRole")?.value || "citizen";
    $("govPassWrap")?.classList.toggle("hide", role !== "gov");
  }

  function updateSessionUI(){
    const chip = $("sessionChip");
    const info = $("authInfo");
    if(session){
      const roleLabel = session.role === "gov" ? "–ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ" : "–ì—Ä–∞–∂–¥–∞–Ω–∏–Ω";
      chip && (chip.textContent = `${session.name} ¬∑ ${roleLabel}`);
      info && (info.textContent = `–°—Ç–∞—Ç—É—Å: –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫ ${roleLabel}`);
    }else{
      chip && (chip.textContent = "–ì–æ—Å—Ç—å");
      info && (info.textContent = "–°—Ç–∞—Ç—É—Å: –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω");
    }
  }

  function setActiveNav(key){
    ["auth","dashboard","report","my","track","admin","help"].forEach(k=>{
      $("nav-"+k)?.classList.toggle("active", k === key);
    });
  }

  function go(name){
    if(name !== "auth" && !session){
      alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç.");
      name = "auth";
    }
    if(name === "admin" && session?.role !== "gov"){
      alert("–î–æ—Å—Ç—É–ø –≤ —Ä–µ–µ—Å—Ç—Ä —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–æ–ª–∏ ¬´–ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ¬ª.");
      name = "dashboard";
    }
    if(name === "report" && session?.role !== "citizen"){
      alert("–ü–æ–¥–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ ¬´–ì—Ä–∞–∂–¥–∞–Ω–∏–Ω¬ª.");
      name = "dashboard";
    }
    if(name === "my" && session?.role !== "citizen"){
      alert("–†–∞–∑–¥–µ–ª ¬´–ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è¬ª –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ ¬´–ì—Ä–∞–∂–¥–∞–Ω–∏–Ω—É¬ª.");
      name = "dashboard";
    }

    ["auth","dashboard","report","my","track","admin","help"].forEach(t=>{
      $("tab-"+t)?.classList.add("hide");
    });
    $("tab-"+name)?.classList.remove("hide");

    setActiveNav(name);

    const isCitizen = session?.role === "citizen";
    const isGov = session?.role === "gov";
    $("nav-report")?.classList.toggle("hide", !isCitizen);
    $("nav-my")?.classList.toggle("hide", !isCitizen);
    $("nav-admin")?.classList.toggle("hide", !isGov);

    renderAll();
  }

  function login(){
    const name = ($("authName")?.value || "").trim();
    const role = $("authRole")?.value || "citizen";
    if(!name){ alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."); return; }

    if(role === "gov"){
      const pass = ($("govPass")?.value || "").trim();
      if(pass !== GOV_PASSWORD){
        alert("–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å");
        return;
      }
    }

    const existing = users.find(u => u.name.toLowerCase() === name.toLowerCase() && u.role === role);
    if(!existing){
      users.push({ name, role, createdAt: Date.now() });
      saveAll();
    }

    setSession({ name, role });

    if($("authName")) $("authName").value = "";
    if($("govPass")) $("govPass").value = "";

    go("dashboard");
  }

  function logout(){
    openCommentId = null;
    setSession(null);
    go("auth");
  }

  function aiClassify(text){
    const t = (text || "").toLowerCase();
    if (/(—è–º–∞|–¥–æ—Ä–æ–≥|–∞—Å—Ñ–∞–ª—å—Ç|—Ç—Ä–µ—â–∏–Ω|–ª—é–∫)/.test(t)) return "roads";
    if (/(—Ñ–æ–Ω–∞—Ä|—Å–≤–µ—Ç|–æ—Å–≤–µ—â)/.test(t)) return "light";
    if (/(–º—É—Å–æ—Ä|—Å–≤–∞–ª–∫|–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä|—É—Ä–Ω)/.test(t)) return "trash";
    if (/(–≤–æ–¥–∞|–∑–∞—Ç–æ–ø|–ø–∞–≤–æ–¥|–ª—É–∂|–∫–∞–Ω–∞–ª–∏–∑–∞—Ü)/.test(t)) return "water";
    return "other";
  }

  function catName(cat){
    return {roads:"–î–æ—Ä–æ–≥–∏", light:"–û—Å–≤–µ—â–µ–Ω–∏–µ", trash:"–ú—É—Å–æ—Ä", water:"–í–æ–¥–∞/–ø–æ–¥—Ç–æ–ø–ª–µ–Ω–∏—è", other:"–î—Ä—É–≥–æ–µ"}[cat] || "‚Äî";
  }

  function statusBadge(i){
    if(i===0) return `<span class="badge b-new">${STATUS[i]}</span>`;
    if(i===1) return `<span class="badge b-proc">${STATUS[i]}</span>`;
    if(i===2) return `<span class="badge b-dept">${STATUS[i]}</span>`;
    return `<span class="badge b-done">${STATUS[i]}</span>`;
  }

  function makeUniqueId(){
    let id, tries = 0;
    do{
      id = Math.floor(1000 + Math.random()*9000);
      tries++;
      if(tries > 60){
        id = Number(String(Date.now()).slice(-4));
        break;
      }
    }while(reports.some(r => r.id === id));
    return id;
  }

  function submitReport(){
    if(!session || session.role !== "citizen"){
      alert("–ü–æ–¥–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ ¬´–ì—Ä–∞–∂–¥–∞–Ω–∏–Ω¬ª.");
      return;
    }

    const desc = ($("desc")?.value || "").trim();
    const loc  = ($("loc")?.value || "").trim();
    const type = $("type")?.value || "auto";
    const region = ($("region")?.value || "").trim();

    if(!desc){ alert("–î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã."); return; }
    if(!region){ alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω."); return; }

    const cat = (type === "auto") ? aiClassify(desc) : type;
    $("aiTag") && ($("aiTag").textContent = "–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è: " + catName(cat));

    const id = makeUniqueId();
    const item = {
      id,
      cat,
      region,
      loc: loc || "‚Äî",
      desc,
      statusIndex: 0,
      citizen: session.name,
      createdAt: Date.now(),
      comments: []
    };

    reports.unshift(item);
    saveAll();
    buildRegionFilter();
    renderAll();

    const res = $("result");
    if(res){
      res.innerHTML = `‚úÖ –û–±—Ä–∞—â–µ–Ω–∏–µ <b>#${id}</b> –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ. –†–µ–≥–∏–æ–Ω: <b>${escapeHtml(region)}</b>. –°—Ç–∞—Ç—É—Å: ${statusBadge(0)}`;
    }

    $("trackId") && ($("trackId").value = id);

    $("desc") && ($("desc").value = "");
    $("loc") && ($("loc").value = "");
    $("type") && ($("type").value = "auto");
    $("region") && ($("region").value = "");
  }

  function track(){
    const id = Number(($("trackId")?.value || "").trim());
    const out = $("trackOut");
    if(!out) return;

    if(!id){ out.innerHTML = "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –æ–±—Ä–∞—â–µ–Ω–∏—è."; return; }
    const item = reports.find(r=>r.id===id);
    if(!item){ out.innerHTML = "–ù–µ –Ω–∞–π–¥–µ–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–æ–º–µ—Ä."; return; }

    const lastComment = item.comments?.length ? item.comments[item.comments.length - 1] : null;

    out.innerHTML = `
      üìå –û–±—Ä–∞—â–µ–Ω–∏–µ <b>#${item.id}</b><br>
      –ö–∞—Ç–µ–≥–æ—Ä–∏—è: <b>${catName(item.cat)}</b><br>
      –†–µ–≥–∏–æ–Ω: <b>${escapeHtml(item.region)}</b><br>
      –õ–æ–∫–∞—Ü–∏—è: <b>${escapeHtml(item.loc)}</b><br>
      –ó–∞—è–≤–∏—Ç–µ–ª—å: <b>${escapeHtml(item.citizen)}</b><br>
      –°—Ç–∞—Ç—É—Å: ${statusBadge(item.statusIndex)}<br>
      ${lastComment ? `
        <div class="panel">
          <b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:</b><br>
          <div style="margin-top:6px;">${escapeHtml(lastComment.text)}</div>
          <div class="hint" style="margin-top:6px;">${new Date(lastComment.at).toLocaleString("ru-RU")}</div>
        </div>
      ` : `<div class="hint" style="margin-top:8px;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –ø–æ–∫–∞ –Ω–µ—Ç.</div>`}
    `;
  }

  function buildRegionFilter(){
    const sel = $("regionFilter");
    if(!sel) return;

    const current = sel.value || "any";
    const regions = Array.from(new Set(reports.map(r => r.region).filter(x => x && x !== "‚Äî"))).sort((a,b)=>a.localeCompare(b,"ru"));

    sel.innerHTML = `<option value="any">–í—Å–µ —Ä–µ–≥–∏–æ–Ω—ã</option>` + regions.map(r=>`<option value="${escapeHtml(r)}">${escapeHtml(r)}</option>`).join("");
    if(regions.includes(current)) sel.value = current;
    else sel.value = "any";
  }

  function setStatus(id, value){
    if(!session || session.role !== "gov"){
      alert("–ú–µ–Ω—è—Ç—å —Å—Ç–∞—Ç—É—Å –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ —Ä–æ–ª—å ¬´–ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ¬ª.");
      return;
    }
    const item = reports.find(r=>r.id===id);
    if(!item) return;
    const idx = Number(value);
    if(Number.isNaN(idx) || idx < 0 || idx >= STATUS.length) return;

    item.statusIndex = idx;
    saveAll();
    renderAll();
  }

  function toggleCommentPanel(id){
    openCommentId = (openCommentId === id) ? null : id;
    renderAll();
    if(openCommentId !== null){
      setTimeout(()=>{ document.getElementById("cmt-"+id)?.focus(); }, 50);
    }
  }

  function addComment(id){
    if(!session || session.role !== "gov"){
      alert("–ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ —Ä–æ–ª—å ¬´–ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ¬ª.");
      return;
    }
    const ta = document.getElementById("cmt-"+id);
    if(!ta) return;

    const text = ta.value.trim();
    if(!text){ alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π."); return; }

    const item = reports.find(r=>r.id===id);
    if(!item) return;

    if(!Array.isArray(item.comments)) item.comments = [];
    item.comments.push({ by: session.name, text, at: Date.now() });

    ta.value = "";
    saveAll();
    renderAll();
  }

  function updateRegion(id){
    if(!session || session.role !== "citizen"){
      alert("–ú–µ–Ω—è—Ç—å —Ä–µ–≥–∏–æ–Ω –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ –≥—Ä–∞–∂–¥–∞–Ω–∏–Ω.");
      return;
    }
    const item = reports.find(r=>r.id===id);
    if(!item) return;
    if(item.citizen !== session.name){
      alert("–ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —Ä–µ–≥–∏–æ–Ω —Ç–æ–ª—å–∫–æ —É —Å–≤–æ–∏—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π.");
      return;
    }
    const sel = document.getElementById("myRegion-"+id);
    if(!sel) return;
    const region = (sel.value || "").trim();
    if(!region){ alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω."); return; }

    item.region = region;
    saveAll();
    buildRegionFilter();
    renderAll();
  }

  function getRegionOptionsHtml(selected){
    const regions = [
      "–ê—Å—Ç–∞–Ω–∞","–ê–ª–º–∞—Ç—ã","–®—ã–º–∫–µ–Ω—Ç",
      "–ê–∫–º–æ–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","–ê–∫—Ç—é–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","–ê–ª–º–∞—Ç–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","–ê—Ç—ã—Ä–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
      "–í–æ—Å—Ç–æ—á–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","–ñ–∞–º–±—ã–ª—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","–ñ–µ—Ç—ã—Å—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","–ó–∞–ø–∞–¥–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
      "–ö–∞—Ä–∞–≥–∞–Ω–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","–ö–æ—Å—Ç–∞–Ω–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","–ö—ã–∑—ã–ª–æ—Ä–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","–ú–∞–Ω–≥–∏—Å—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
      "–ü–∞–≤–ª–æ–¥–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","–°–µ–≤–µ—Ä–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","–¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
      "–£–ª—ã—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","–ê–±–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"
    ];
    return regions.map(r => `<option ${r===selected ? "selected" : ""}>${escapeHtml(r)}</option>`).join("");
  }

  function renderAll(){
    const total = reports.length;
    const active = reports.filter(r => r.statusIndex >= 1 && r.statusIndex <= 2).length;
    const done = reports.filter(r => r.statusIndex === 3).length;

    $("kpiTotal") && ($("kpiTotal").textContent = total);
    $("kpiActive") && ($("kpiActive").textContent = active);
    $("kpiDone") && ($("kpiDone").textContent = done);

    $("myUser") && ($("myUser").textContent = session?.name || "‚Äî");

    const myList = $("myList");
    if(myList){
      if(!session || session.role !== "citizen"){
        myList.innerHTML = "‚Äî";
      }else{
        const mine = reports.filter(r => r.citizen === session.name);
        myList.innerHTML = mine.length ? mine.map(r=>{
          const last = r.comments?.length ? r.comments[r.comments.length - 1] : null;
          const regionOptions = getRegionOptionsHtml(r.region);

          return `
            <div class="card">
              <div class="row" style="justify-content:space-between;">
                <div><b>#${r.id}</b> ¬∑ ${catName(r.cat)}</div>
                <div>${statusBadge(r.statusIndex)}</div>
              </div>

              <div class="hint" style="margin-top:8px;"><b>–õ–æ–∫–∞—Ü–∏—è:</b> ${escapeHtml(r.loc)}</div>
              <div class="hint"><b>–†–µ–≥–∏–æ–Ω:</b></div>

              <div class="row" style="margin-top:6px;">
                <select id="myRegion-${r.id}" style="max-width:360px;">${regionOptions}</select>
                <button class="mini-btn" onclick="updateRegion(${r.id})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–≥–∏–æ–Ω</button>
              </div>

              <div style="margin-top:10px;">${escapeHtml(r.desc)}</div>

              ${last ? `
                <div class="panel">
                  <b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:</b>
                  <div style="margin-top:6px;">${escapeHtml(last.text)}</div>
                  <div class="hint" style="margin-top:6px;">${new Date(last.at).toLocaleString("ru-RU")}</div>
                </div>
              ` : `<div class="hint" style="margin-top:8px;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –ø–æ–∫–∞ –Ω–µ—Ç.</div>`}
            </div>
          `;
        }).join("") : "–ù–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π.";
      }
    }

    const tbody = $("tbody");
    if(tbody){
      if(!session || session.role !== "gov"){
        tbody.innerHTML = "";
      }else{
        const catF = $("filter")?.value || "all";
        const stF  = $("statusFilter")?.value || "any";
        const regF = $("regionFilter")?.value || "any";

        let list = [...reports];
        if(catF !== "all") list = list.filter(r => r.cat === catF);
        if(stF !== "any") list = list.filter(r => String(r.statusIndex) === stF);
        if(regF !== "any") list = list.filter(r => r.region === regF);

        tbody.innerHTML = list.length ? list.map(r=>{
          const last = r.comments?.length ? r.comments[r.comments.length - 1] : null;

          const statusOptions = STATUS.map((s, i)=>
            `<option value="${i}" ${i===r.statusIndex ? "selected" : ""}>${s}</option>`
          ).join("");

          return `
            <tr>
              <td>
                <b>${r.id}</b>
                <div class="hint">${new Date(r.createdAt).toLocaleString("ru-RU")}</div>
              </td>
              <td>${catName(r.cat)}</td>
              <td>${escapeHtml(r.citizen)}</td>
              <td class="wrap">${escapeHtml(r.region)}</td>
              <td class="wrap">${escapeHtml(r.loc)}</td>
              <td>
                <select class="status-select" onchange="setStatus(${r.id}, this.value)">
                  ${statusOptions}
                </select>
                <div style="margin-top:8px;">${statusBadge(r.statusIndex)}</div>
              </td>
              <td>
                <button class="mini-btn" onclick="toggleCommentPanel(${r.id})">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π${last ? " ‚Ä¢" : ""}</button>
                ${openCommentId === r.id ? `
                  <div class="panel">
                    <textarea id="cmt-${r.id}" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –≥—Ä–∞–∂–¥–∞–Ω–∏–Ω–∞..."></textarea>
                    <div class="row" style="margin-top:8px;">
                      <button class="btn" onclick="addComment(${r.id})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                      <button class="btn2" onclick="toggleCommentPanel(${r.id})">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                  </div>
                ` : ``}
              </td>
            </tr>
          `;
        }).join("") : `<tr><td colspan="7" class="hint">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º.</td></tr>`;
      }
    }
  }
</script>
</body>
</html>